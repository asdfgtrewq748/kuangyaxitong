# MPI 热力图核心功能升级计划 (Project Core: MPI Heatmap 2.0)

## 1. 愿景与目标 (Vision)
打造项目的**绝对核心页面**。从“静态数据展示”向“动态数值模拟”演进。
- **全域感知**：进入页面即展示整个采区的矿压分布（Global View），无需前置条件。
- **动态仿真**：模拟采动过程，实时渲染矿压指标（MPI）的时空演化。
- **核心体验**：达到工业软件级的交互流畅度与可视化水准。

## 2. 核心痛点与解决方案 (Pain Points & Solutions)

| 当前痛点 | 升级方案 |
| :--- | :--- |
| **被动交互**：必须先上传/选择工作面才能看图 | **主动展示**：默认基于所有钻孔数据生成全矿区背景场，工作面仅作为"关注区"（ROI）叠加显示。 |
| **静态快照**：一次计算一张图，无法观察变化 | **动态模拟**：引入"时间步/推进度"概念，通过滑块或播放键演示开采过程中的压力迁移。 |
| **割裂感**：设置与展示分离，操作繁琐 | **沉浸式UI**：全屏地图底座，参数面板悬浮/折叠，所见即所得。 |
| **性能瓶颈**：纯图片/Canvas重绘，交互卡顿 | **高性能渲染**：优化Canvas层级（背景层/动态层/UI层分离），必要时引入WebGL着色器。 |

## 3. 功能架构设计 (Feature Architecture)

### 3.1 布局重构 (Immersive Layout)
- **底层 (Background)**: 全屏 MPI 热力图（全矿区插值）。
- **中层 (Simulation)**: 动态图层（开采扰动范围、应力集中区）。
- **顶层 (Overlay)**:
  - **左上**: 核心指标看板 (Global Stats)。
  - **右上**: 图层控制 & 工具栏 (Layers & Tools)。
  - **底部**: 时间轴/推进度控制器 (Simulation Timeline)。
  - **交互**: 鼠标滚轮缩放、右键平移、左键框选/探针。

### 3.2 交互逻辑 (Interaction Logic)
1.  **初始化**: 自动加载默认煤层数据，计算并渲染全矿区初始 MPI 场。
2.  **工作面操作**:
    - **选择模式**: 点击已有工作面，高亮显示，并自动聚焦。
    - **规划模式**: 在图上直接绘制/框选新工作面区域。
3.  **模拟推演**:
    - 开启"模拟模式"。
    - 设定推进方向与步距。
    - 拖动时间轴，热力图根据"采动影响函数"实时更新局部区域颜色。

## 4. 技术实施方案 (Technical Implementation)

### 第一阶段：全局化与交互优化 (Phase 1: Global & Interactive)
- **任务 1.1: 数据层改造**
  - 修改 `MpiHeatmap.vue`，加载时获取全矿区边界（所有钻孔的包围盒 + 缓冲）。
  - 后端增加 `/mpi/global` 接口，支持只传煤层ID即返回全场低分辨率网格（用于快速首屏）。
- **任务 1.2: 视口变换 (Viewport Transform)**
  - 实现 Canvas 的平移 (Pan) 和缩放 (Zoom) 功能。
  - 坐标映射系统重写：`World (Geo) <-> Screen (Pixel)` 双向转换。
- **任务 1.3: UI 沉浸化**
  - 移除左右分栏，改为全屏布局。
  - 将侧边栏改为悬浮磨砂玻璃面板 (Glassmorphism Panel)。

### 第二阶段：动态模拟引擎 (Phase 2: Simulation Engine)
- **任务 2.1: 前端模拟状态机**
  - 引入 Pinia 或 reactive state 管理 `CurrentStep`, `MiningPosition`.
- **任务 2.2: 局部更新算法**
  - **方案 A (纯前端)**: 简单的衰减函数叠加。如果不重新跑复杂插值，仅在前端做像素级颜色混合（性能最快，适合演示）。
  - **方案 B (混合计算)**: 后端预计算关键帧，前端插值补间（准确度高）。
  - *推荐方案*: 既然强调“数值模拟”，建议前端实现简化的 MPI 扰动算法，实时修改 Grid 数据并重绘 Canvas。

### 第三阶段：可视化增强 (Phase 3: Visual Polish)
- **任务 3.1: 等值线 (Contour Lines)**
  - 使用 `d3-contour` 或 `marchingsquares` 算法在热力图上叠加等值线。
- **任务 3.2: 动态光效**
  - 高风险区域（MPI < 50）增加呼吸灯效或动态纹理。

## 5. 执行计划 (Action Plan)

### Step 1: 原型重构 (Refactor)
- [ ] 创建新视图 `frontend/src/views/MpiHeatmapPro.vue` (保留旧版备用)。
- [ ] 实现全屏 Canvas 基础组件，支持 Pan/Zoom。
- [ ] 对接现有 API，实现"无工作面"时的全局渲染。

### Step 2: 核心功能 (Core Features)
- [ ] 移植并优化 `MpiHeatmapViewer` 的绘图逻辑，分离 `StaticLayer` (背景) 和 `DynamicLayer` (动态)。
- [ ] 实现悬浮参数面板。

### Step 3: 模拟演示 (Simulation)
- [ ] 添加底部时间轴组件。
- [ ] 实现"虚拟开采"逻辑：点击播放，工作面矩形沿走向移动，热力图跟随变化。

## 6. 立即行动 (Immediate Actions)
我将首先创建一个**新的全屏版页面原型**，验证全局渲染和缩放交互。
