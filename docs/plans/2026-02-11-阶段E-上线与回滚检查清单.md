# 阶段 E 上线与回滚检查清单

## 1. 发布前检查

1. 版本与分支
- [ ] 发布分支与提交号已冻结。
- [ ] `task_plan.md` 与阶段文档已更新到当前状态。

2. 配置与依赖
- [ ] 后端依赖版本与目标环境一致（Python/库版本锁定）。
- [ ] `DATA_DIR`、日志目录、权限已验证可写。
- [ ] Geomodel 相关依赖可加载，缺失时降级路径可用。

3. 数据与任务链路
- [ ] `POST /api/geomodel/jobs` 创建任务成功。
- [ ] `GET /api/geomodel/jobs/{job_id}` 状态轮询正常。
- [ ] 标准产物可下载：`summary.json`、`quality_report.json`。

4. 核心接口健康
- [ ] `POST /api/mpi/interpolate` 正常返回。
- [ ] `POST /api/mpi/interpolate-geo` 正常返回（含 fallback 标记）。
- [ ] 科研模板接口：`/api/research/experiments/templates`、`/run-suite` 正常。

5. 性能基线
- [ ] 已完成 3 轮压测 JSON 采样。
- [ ] 已执行阈值评估脚本并输出结论：
  - `python scripts/perf/evaluate_backend_perf.py --reports <run1> <run2> <run3>`
- [ ] 若未达标，已记录瓶颈与优化责任人。

## 2. 灰度发布步骤

1. 灰度 10%
- [ ] 先开放基础链路，观察错误率和延迟 30 分钟。

2. 灰度 30%
- [ ] 开启地质增强能力，验证 `fallback` 比例是否异常。

3. 灰度 100%
- [ ] 监控稳定后全量切换。

## 3. 监控与告警检查

1. 关键指标
- [ ] 接口成功率
- [ ] P95/P99 延迟
- [ ] Geomodel 队列积压长度
- [ ] 证据包导出成功率

2. 告警路由
- [ ] 告警接收人和值班群生效。
- [ ] 告警阈值与阶段 E 基线一致。

## 4. 回滚预案

1. 触发条件
- [ ] 核心接口成功率持续低于阈值（例如 99%）。
- [ ] P95 延迟持续超阈值且 15 分钟无法恢复。
- [ ] 建模任务队列积压失控或持续失败。

2. 回滚动作
- [ ] 关闭 geology-aware 开关，回退到 baseline 模式。
- [ ] 回滚到上一稳定版本镜像/包。
- [ ] 暂停新建 Geomodel 任务，保留已完成产物下载。

3. 回滚后验证
- [ ] 重新验证核心接口健康。
- [ ] 复跑最小回归清单（Interpolation / MpiHeatmapPro / Report）。
- [ ] 输出事故记录（触发时间、影响范围、处置过程、后续修复计划）。

## 5. 发布后 24h 观察

- [ ] 每 2 小时记录一次核心指标快照。
- [ ] 记录异常事件与恢复时长。
- [ ] 形成《阶段 E 发布观察报告》。
