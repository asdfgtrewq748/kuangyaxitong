# 阶段 B 实施方案：MPI 计算增强（geology-aware）

## 1. 阶段目标

1. 在保留现有 MPI 算法接口的前提下，新增地质约束增强能力。  
2. 让 MPI 结果可追溯到地质模型特征，不再仅依赖基础岩层参数。  
3. 支持 baseline 与 geology-aware 并行对照输出。

---

## 2. 设计范围

### 2.1 重点文件
- `backend/app/services/mpi_new_algorithm.py`
- `backend/app/services/geomodel_features.py`（新增）
- `backend/app/routes/mpi.py`（新增 geology-aware 入口）
- `backend/tests/test_mpi_geo_api.py`（新增）

### 2.2 输入来源
- 阶段 A 产物：`summary.json`、`quality_report.json`

---

## 3. 目标能力

1. 地质特征提取  
- `key_layer_span`（关键层跨度）  
- `continuity_score`（连续性评分）  
- `pinchout_ratio`（尖灭比例）  
- `layer_cv`（厚度变异系数）  

2. 新计算入口  
- `POST /api/mpi/calculate-geo`

3. 输出增强字段  
- `feature_source`
- `feature_values`
- `algorithm_mode`（`baseline` / `geology_aware`）
- `comparison`（可选）

---

## 4. 接口建议

请求：
- 点位数据（兼容现有 `PointData`）
- 可选 `geomodel_job_id`
- 可选 `feature_overrides`
- 可选 `weights`

响应：
- `mpi`、`breakdown`
- `diagnostics`
- `feature_trace`（来源、值、可用性）
- `fallback_used`（是否回退 baseline）

---

## 5. 开发任务拆分

1. 实现 `geomodel_features.py`  
- 从产物提取统一特征
- 缺失/异常特征容错处理

2. 扩展 `mpi_new_algorithm.py`  
- 增加特征影响路径
- 增加特征权重归一化逻辑

3. 路由扩展  
- 新增 `calculate-geo`
- 请求参数校验与错误码规范

4. 对照机制  
- 同请求可返回 baseline 与 geology-aware 两套结果（可开关）

5. 测试  
- 特征存在/缺失/异常三类场景
- 回退逻辑稳定性验证

---

## 6. 验收标准

1. 新接口可在有效地质产物下输出 geology-aware 结果。  
2. 地质产物不可用时自动回退 baseline，并显式标记。  
3. 相同输入在固定参数下结果可复现。  
4. 覆盖核心逻辑测试用例通过。

---

## 7. 风险与应对

1. 特征质量不稳定  
- 方案：每个特征输出 quality flag；低质量时降权或忽略。

2. 算法口径漂移  
- 方案：维护基线数据集 + 每日回归对照。

3. 指标解释困难  
- 方案：返回特征贡献分解与简要文本解释。

---

## 8. 交付物

1. geology-aware API 与服务实现。  
2. 特征提取模块与说明文档。  
3. baseline 对照报告模板。  
4. 阶段 B 验收记录。

