# 阶段 A 实施方案：后端基座（Geomodel 服务化）

## 1. 阶段目标

1. 在现有 MPI 后端中新增可独立运行的 Geomodel 作业服务。  
2. 打通“任务创建 -> 进度查询 -> 产物下载”的完整链路。  
3. 统一建模产物结构，为阶段 B/C 提供稳定输入。

---

## 2. 设计范围

### 2.1 新增模块
- `backend/app/routes/geomodel.py`
- `backend/app/services/geomodel_service.py`
- `backend/app/schemas/geomodel.py`
- `backend/tests/test_geomodel_api.py`

### 2.2 复用来源
- `dizhijianmo/server/services/modeling_v2.py`
- `dizhijianmo/server/modeling/thickness_modeling.py`
- `dizhijianmo/server/modeling/regression_kriging.py`

---

## 3. 接口定义（建议）

1. `POST /api/geomodel/jobs`  
- 功能：创建建模作业  
- 入参：`method`、`seam_name`、`resolution`、`layer_order_method`、`pinchout_strategy`、`output_formats`

2. `GET /api/geomodel/jobs/{job_id}`  
- 功能：查询作业状态与进度  
- 出参：`status`、`progress`、`message`、`result_manifest`

3. `GET /api/geomodel/jobs/{job_id}/artifacts`  
- 功能：列出产物清单  
- 出参：文件名、大小、更新时间、类型、下载 URL

4. `GET /api/geomodel/jobs/{job_id}/artifacts/{name}`  
- 功能：下载指定产物

---

## 4. 产物协议

标准产物：
1. `summary.json`  
- 层序、各层厚度统计、覆盖率、方法参数摘要

2. `quality_report.json`  
- 连续性指标、尖灭比例、梯度指标、异常分布

3. `model.vtk` / `layer_*.vtp`  
- 主模型和分层可视化产物

4. `exports/*`  
- 可选工程导出（STL/DXF/FLAC3D/F3GRID）

manifest 建议字段：
- `job_id`
- `method`
- `input_signature`
- `created_at`
- `artifacts[]`
- `quality_summary`

---

## 5. 开发任务拆分

1. 路由层开发  
- 创建作业、查询状态、列举产物、下载产物

2. 服务层开发  
- 参数校验、任务调度、作业执行、产物落盘、错误处理

3. Schema 定义  
- 请求模型、响应模型、产物清单模型

4. 兼容与降级策略  
- 某方法不可用时降级到可用方法并记录 warning

5. 测试  
- 正常流程、非法参数、作业失败、产物缺失、并发任务

---

## 6. 验收标准

1. 用现有 `backend/data` 可以生成至少 1 个成功作业。  
2. 作业状态可轮询，产物可下载。  
3. 失败场景返回可定位的错误信息。  
4. 测试覆盖核心接口与核心服务路径。

---

## 7. 风险与应对

1. 运行时依赖不一致  
- 方案：将 Geomodel 依赖声明独立化，增加启动自检。

2. 任务耗时长导致阻塞  
- 方案：后台任务执行 + 非阻塞状态查询。

3. 产物格式不统一  
- 方案：所有作业统一输出 `manifest`。

---

## 8. 交付物

1. 可用 API 与服务代码。  
2. 产物协议文档与示例文件。  
3. 接口测试与服务单元测试。  
4. 阶段 A 验收记录。

