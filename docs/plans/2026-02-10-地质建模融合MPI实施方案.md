# 地质建模融合 MPI 系统实施方案

## 1. 目标与范围

### 1.1 总体目标
- 将 `dizhijianmo` 已跑通的地质建模能力（分层建模、智能尖灭、回归克里金、质量诊断、多格式导出）融合到现有矿压 MPI 系统。
- 在不破坏现有业务主流程的前提下，形成“地质模型 -> MPI 指标 -> 实证评估 -> 科研产出”的闭环。
- 增强 2D/3D 可视化能力，提升科研可解释性与论文证据完整度。

### 1.2 融合边界
- 不迁移 Qt 桌面 UI。
- 迁移算法、任务编排、结果格式、质量诊断和导出链路。
- 采用“新增 Geomodel 服务层 + 现有页面渐进接入”的策略。

---

## 2. 目标架构（推荐）

```
数据导入/插值分析
      │
      ▼
Geomodel 作业服务（新增）
- 分层建模 / 智能尖灭 / 回归克里金
- 任务状态 / 进度推送 / 结果产物
      │
      ├── 3D模型产物（VTK/VTP/STL/FLAC3D等）
      ├── 质量诊断（连续性/尖灭/层序/覆盖率）
      └── 特征摘要（供MPI计算与实证使用）
      │
      ▼
MPI与实证层（现有增强）
- MPI指标计算（可接收地质约束特征）
- 空间热力图/步距建议/实证评估/科研工作台
```

---

## 3. 实施清单（可执行）

## 阶段 A：后端基座（第 1-2 周）

1. 新增 Geomodel 路由与任务接口  
   - 新建：`backend/app/routes/geomodel.py`  
   - 接口建议：  
     - `POST /api/geomodel/jobs`  
     - `GET /api/geomodel/jobs/{job_id}`  
     - `GET /api/geomodel/jobs/{job_id}/artifacts`  
     - `GET /api/geomodel/jobs/{job_id}/artifacts/{name}`  

2. 新增 Geomodel 服务层  
   - 新建：`backend/app/services/geomodel_service.py`  
   - 复用/迁移能力来源：`dizhijianmo/server/services/modeling_v2.py`  
   - 支持方法：`thickness`、`hybrid`、`regression_kriging`、`smart_pinchout`

3. 定义统一建模入参与结果协议  
   - 新建：`backend/app/schemas/geomodel.py`  
   - 统一字段：煤层、分辨率、层序策略、尖灭策略、插值方法、输出格式

4. 结果产物规范化  
   - 标准产物：  
     - `summary.json`（层序、统计）  
     - `quality_report.json`（连续性与异常）  
     - `layer_*.vtp` / `model.vtk`  
     - `exports/*.stl|dxf|flac3d|f3grid`

5. 单元测试与接口测试  
   - 新增：`backend/tests/test_geomodel_api.py`  
   - 覆盖：任务创建、状态轮询、产物读取、参数校验、失败回退

验收标准：
- 能用当前 `backend/data` 数据启动建模作业并得到标准产物。
- 任务状态可查询，失败有明确错误信息。

## 阶段 B：MPI 计算增强（第 3 周）

1. 扩展 MPI 输入特征  
   - 文件：`backend/app/services/mpi_new_algorithm.py`  
   - 新增可选输入：`key_layer_span`、`layer_cv`、`pinchout_ratio`、`continuity_score`

2. 增加 geology-aware 计算入口  
   - 新增接口：`POST /api/mpi/calculate-geo`（兼容旧版不破坏）
   - 若无地质特征则回退现有算法

3. 构建地质特征提取器  
   - 新建：`backend/app/services/geomodel_features.py`  
   - 从 `summary.json`、`quality_report.json` 中抽取 MPI 需要的结构化特征

验收标准：
- 新入口可输出 MPI 且可追溯到地质特征来源。
- 不影响现有 `/api/mpi/calculate` 和 `/api/mpi/interpolate`。

## 阶段 C：前端页面接入（第 4-5 周）

1. 插值分析页（`frontend/src/views/Interpolation.vue`）  
   - 增加“建模任务发起”与“质量诊断摘要卡”  
   - 增加方法对比结果（IDW/Kriging/RK/Hybrid）

2. MPI 数值模拟页（`frontend/src/views/MpiHeatmapPro.vue`）  
   - 增加 3D 模型联动入口（图层开关、透明度、剖切）  
   - 热力图和 3D 视图联动高亮

3. 新算法实证页（`frontend/src/views/AlgorithmValidation.vue`）  
   - 增加“地质约束开关”  
   - 增加 geology-aware vs baseline 对照图

4. 来压步距页（`frontend/src/views/Steps.vue`）  
   - 结合关键层跨度、尖灭区给出步距修正建议

5. 结果报告页（`frontend/src/views/Report.vue`）  
   - 新增“地质模型质量章节”（连续性/零值占比/梯度/异常斑块）

验收标准：
- 至少 3 个页面可直接消费 Geomodel 结果。
- 前端交互可在 2D/3D 间切换并查看联动信息。

## 阶段 D：科研工作台闭环（第 6 周）

1. 科研工作台模板扩展（`frontend/src/views/ResearchWorkbench.vue`）  
   - 新增实验模板：  
     - `geomodel_ablation`  
     - `pinchout_effect`  
     - `rk_vs_kriging`

2. 后端实验模板扩展  
   - 文件：`backend/app/services/experiment_runner.py`  
   - 将地质模型质量指标纳入实验结果

3. 证据包增强  
   - 输出：模型摘要、质量诊断、对比图件、统计检验表

验收标准：
- 可一键跑通“模型->实证->报告”的科研流程。
- 产物可直接用于论文附录或审稿补充材料。

---

## 4. 页面优化与可视化增强清单

1. 数据导入（`/data`）  
- 新增“建模数据体检”卡片：层序冲突、缺参率、坐标异常、可建模评分。

2. 插值分析（`/interpolation`）  
- 新增模型选择依据图：LOOCV MAE/RMSE/R2 对比。  
- 新增不确定性分解图：采样稀疏贡献 vs 方法误差贡献。

3. MPI 数值模拟（`/mpi-heatmap-pro`）  
- 新增 3D 地层模型叠加，支持推进过程联动剖面。

4. 新算法实证（`/algorithm-validation`）  
- 增加按地层分区的混淆矩阵、校准曲线、风险误判热区。

5. 来压步距（`/steps`）  
- 新增“步距-关键层跨度”关联图和分区修正建议。

6. 结果报告（`/report`）  
- 增加“工程版/论文版”双模板导出，附质量诊断摘要。

7. 科研工作台（`/research-workbench`）  
- 增加实验追踪看板：数据版本、切分策略、防泄漏审计、显著性检验。

---

## 5. 科研价值与直接产出

1. 可解释性增强  
- 风险结论可定位到具体层位与结构异常，不再只给黑盒分值。

2. 实证严谨性增强  
- 支持基线对照、消融实验、分区评估、校准与显著性检验。

3. 复现性增强  
- 数据哈希、参数快照、产物清单完整记录，满足投稿复现要求。

4. 工程耦合增强  
- 支持 FLAC3D/F3GRID 导出，方便数值仿真复核与工程闭环。

---

## 6. 风险与应对

1. 依赖冲突（PyKrige/VTK/Scipy）  
- 方案：Geomodel 服务依赖隔离，使用独立模块与环境说明。

2. 大模型计算耗时  
- 方案：作业队列 + 进度推送 + 结果缓存 + 分辨率分级策略。

3. 页面复杂度提升  
- 方案：先增“专家模式”入口，默认保持现有轻量视图。

4. 算法口径漂移  
- 方案：锁定基准数据集，建立回归测试与阈值告警。

---

## 7. 里程碑（建议）

1. M1（第2周末）：Geomodel API 与产物链路可用  
2. M2（第3周末）：MPI geology-aware 指标跑通  
3. M3（第5周末）：前端三页（插值/模拟/实证）联通  
4. M4（第6周末）：科研工作台完成证据包闭环

---

## 8. Definition of Done

1. 功能层  
- 可创建并完成建模任务，产物完整可下载。  
- MPI 可消费地质特征并输出对照结果。

2. 质量层  
- 单元测试与接口测试通过。  
- 关键路径有回归测试（数据体检、建模作业、MPI对照）。

3. 业务层  
- 至少 3 个核心页面可见融合价值。  
- 报告可直接输出用于汇报和科研材料。

