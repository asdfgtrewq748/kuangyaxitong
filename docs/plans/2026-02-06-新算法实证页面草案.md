# 新算法实证页面草案（论文导向）

## 0. 当前状态结论
1. 目前系统里还没有“新算法实证页面”，现有主要是展示页 `frontend/src/views/AcademicAlgorithm.vue` 与旧数值模拟页 `frontend/src/views/MpiHeatmapPro.vue`。
2. 新算法后端接口已存在于 `backend/api_server.py`（`/api/rsi/phase-field`、`/api/bri/microseismic`、`/api/asi/ust`、`/api/fusion/dbn`、`/api/comprehensive-assessment`）。
3. 当前工程存在双后端口：主业务 API 在 `http://localhost:8001`（`frontend/src/api.js`），新算法演示 API 默认 `http://localhost:5000`（`AcademicAlgorithm.vue`）；实证页上线前必须统一。

## 1. 页面目标与科研定位
1. 页面定位：面向“真实数据+可复现实验”的论文式验证页面，不是纯介绍页。
2. 科研问题：新算法是否在真实矿压场景中优于旧算法，是否稳定、可解释、可复现。
3. 输出对象：研究人员、工程决策人员、评审专家；三类人都能在同页看到“结论-证据-方法”闭环。
4. 页面名称建议：`新算法实证（Algorithm Validation Lab）`，路由建议 `/algorithm-validation`。

## 2. 页面信息架构（从上到下）
1. 模块A「研究摘要条」：展示实验名称、数据时间范围、样本数、运行版本号、核心结论一句话；作用是先给结论。
2. 模块B「数据质量与覆盖」：展示钻孔空间覆盖图、微震事件时间分布、缺失率矩阵、异常值占比；作用是先证明数据可信。
3. 模块C「实验配置面板」：数据集选择、训练/验证时间窗、算法参数（RSI/BRI/ASI/DBN）、阈值方案、基线算法选择；支持保存配置快照（便于复现实验）。
4. 模块D「一键运行与日志」：运行按钮、进度条、阶段日志（预处理/单模块计算/融合推理/评估）、失败重试；作用是让流程透明。
5. 模块E「核心结果总览」：四个 KPI 卡片（MPI均值、High-risk占比、AUC、Brier Score），加一个综合结论卡片（是否优于基线、提升百分比）。
6. 模块F「机制结果分区」：分三列展示 RSI、BRI、ASI 的输入、计算中间量、输出结果；每列都给“图+一句解释+可下载原始数据”。
7. 模块G「融合与时序推理」：DBN 时间片网络图、后验概率随时间曲线、置信区间带、关键转折点注释；作用是解释为何最终风险等级变化。
8. 模块H「论文证据区」：基线对比、消融实验、灵敏度分析、校准曲线、误差分解；所有图表直接按论文图号组织。
9. 模块I「导出与复现」：导出图表（SVG/PNG）、导出表格（CSV/Excel）、导出实验包（JSON：参数+版本+结果摘要）。

## 3. 真实数据驱动方案
1. 数据输入清单：钻孔/岩层参数、微震事件、支护与应力边界、历史风险标签（若有）。
2. 数据最小字段：`borehole_id,x,y,strata[]`；`event_time,x,y,z,magnitude`；`tunnel_radius,original_stress,support_pressure,ust_b`；`label_time,label_level`。
3. 数据流：导入与清洗 -> 参数标准化 -> RSI/BRI/ASI并行计算 -> DBN融合 -> 指标评估 -> 报告导出。
4. 与现有接口衔接：复用 `backend/app/main.py` 中数据导入与岩性查询能力；调用 `backend/api_server.py` 的新算法接口执行计算。
5. 强制校验：缺失值阈值、单位一致性（MPa/m/GPa）、时间戳时区、坐标范围合法性；未通过则禁止运行。

## 4. 后端接口契约（建议）
1. 保留现有分模块接口：`/api/rsi/phase-field`、`/api/bri/microseismic`、`/api/asi/ust`、`/api/fusion/dbn`，用于单模块调试和图表细节。
2. 新增统一实验接口：`POST /api/algorithm-validation/run`；入参为数据引用ID+参数快照，返回 `run_id`。
3. 新增结果查询接口：`GET /api/algorithm-validation/result/{run_id}`；返回 KPI、各模块结果、图表数据、错误信息。
4. 新增评估接口：`POST /api/algorithm-validation/evaluate`；返回 AUC、PR-AUC、F1、Brier、ECE、混淆矩阵、分层统计。
5. 新增导出接口：`GET /api/algorithm-validation/export/{run_id}`；导出 zip（图+表+配置+版本）。

## 5. 图表与表格清单（论文风）
1. Fig.1 数据覆盖与质量总览：空间覆盖图 + 时间分布 + 缺失热力图。
2. Fig.2 RSI 机制图：裂纹演化与损伤区；附 RSI 分值映射条。
3. Fig.3 BRI 机制图：矩张量分解占比（ISO/DC/CLVD）与事件能量释放曲线。
4. Fig.4 ASI 机制图：径向/切向应力曲线 + 塑性区半径。
5. Fig.5 DBN 时序推理图：时间片网络 + 后验概率曲线 + 置信带。
6. Fig.6 主结果对比图：新算法 vs 旧算法在关键指标上的提升柱状图。
7. Fig.7 消融实验图：去掉 RSI/BRI/ASI 任一模块后的性能下降。
8. Fig.8 校准曲线图：预测概率与真实频率一致性。
9. Table 1 数据集统计：样本量、时间跨度、特征数量、缺失率。
10. Table 2 主结果：AUC、F1、Brier、误报率、漏报率。
11. Table 3 参数灵敏度：关键参数变化对指标影响。

## 6. 页面交互细节（让新用户看得懂）
1. 每个图必须有「怎么读这张图」短说明（2行以内）和「工程意义」短说明（2行以内）。
2. 先展示结论再展示机理：默认打开总览和主结果，不把用户直接扔进公式。
3. 所有专业术语提供悬浮释义；第一次进入显示 3 步引导（看结论、看证据、看公式）。
4. 每个 KPI 卡片支持点击下钻到对应图表（从结论回溯证据）。

## 7. MVP 实施分期（建议 3 周）
1. 第1周：搭页面骨架与真实数据接入，完成模块A~E，能跑通一次完整计算。
2. 第2周：完成模块F~H，补齐对比/消融/校准评估，接通导出。
3. 第3周：完善异常处理、性能优化、论文风样式统一、复现实验包。

## 8. 验收标准
1. 任意真实数据集可在 3 分钟内完成一次运行并得到完整结果。
2. 同一配置重复运行，核心指标波动在预设阈值内（可复现）。
3. 新用户在不看代码的情况下，5 分钟内能读懂“结论+依据+不确定性”。
4. 图表和表格可直接进入论文初稿，无需二次重画。

## 9. 页面线框草图（Desktop 优先）
1. 顶部固定摘要条（高度约 96px）：
`实验名称 | 数据集 | 时间窗 | run_id | 结论标签(优于/持平/劣于基线)`。
2. 主体两栏（左 320px 固定宽，右自适应）：
左栏为配置与运行，右栏为结果与图表。
3. 左栏分 4 卡：
数据集卡、参数卡、基线卡、运行日志卡。
4. 右栏分 5 组折叠区：
`总览KPI -> 三机制结果 -> DBN时序 -> 论文证据 -> 导出`。
5. 每个图卡统一结构：
`图标题(Fig.X) -> 图本体 -> 怎么读 -> 工程意义 -> 下载按钮`。
6. Mobile 适配策略：
左栏转为顶部抽屉；图表按 “总览优先” 单列堆叠，先显示 KPI 与结论。

## 10. 前端实施蓝图（Vue3）
1. 新建页面：`frontend/src/views/AlgorithmValidation.vue`。
2. 路由新增：`frontend/src/router/index.js` 增加 `/algorithm-validation`。
3. 侧边栏图标：`frontend/src/layouts/AppLayout.vue` 增加 `AlgorithmValidation` 图标映射。
4. API 封装：`frontend/src/api.js` 新增：
`validationRun`、`validationResult`、`validationEvaluate`、`validationExport`。
5. 组件拆分建议（避免单文件过大）：
`frontend/src/components/validation/ValidationConfigPanel.vue`、
`ValidationKpiCards.vue`、
`ValidationMechanismPanel.vue`、
`ValidationDbnPanel.vue`、
`ValidationEvidencePanel.vue`、
`ValidationExportPanel.vue`。
6. 状态管理建议：
页面内用 `reactive` 管理 `runState/resultState`，避免引入新状态库；
长任务结果按 `run_id` 缓存到 `sessionStorage`，防止刷新丢失。
7. 图表库：
继续使用 ECharts；图表导出优先 SVG（论文可编辑），备选 PNG 300 DPI。

## 11. 后端实施蓝图（FastAPI）
1. 新增路由文件：`backend/app/routes/algorithm_validation.py`。
2. 在 `backend/app/main.py` 中 `include_router(validation_router)`。
3. 新增服务文件：
`backend/app/services/validation_runner.py`（统一调度 RSI/BRI/ASI/DBN）、
`backend/app/services/validation_metrics.py`（AUC/F1/Brier/ECE 等）、
`backend/app/services/validation_export.py`（打包导出）。
4. 运行结果持久化：
首版落盘到 `backend/data/validation_runs/{run_id}.json`，便于复现与审计。
5. 接口端口统一原则：
优先把新算法能力并入 `:8001` 主后端，避免前端跨双端口调用。

## 12. 接口契约细化（请求/响应示例）
1. `POST /api/algorithm-validation/run`
```json
{
  "dataset_id": "mineA_2025Q4",
  "time_window": {"train_start":"2025-01-01","train_end":"2025-10-31","test_start":"2025-11-01","test_end":"2025-12-31"},
  "params": {
    "rsi": {"mesh_size": 80, "time_steps": 15},
    "bri": {"time_window_days": 7},
    "asi": {"tunnel_radius": 3.0, "original_stress": 10.0, "support_pressure": 0.5, "ust_parameter_b": 0.5},
    "dbn": {"weights": {"rsi": 0.4, "bri": 0.35, "asi": 0.25}}
  },
  "baseline": {"name":"old_mpi_v1"}
}
```
返回：
```json
{"run_id":"run_20260206_143015_01","status":"running"}
```
2. `GET /api/algorithm-validation/result/{run_id}`
返回核心字段：
`status`、`kpi`、`modules.rsi/bri/asi`、`fusion`、`figures`、`tables`、`errors`。
3. `POST /api/algorithm-validation/evaluate`
输入 `y_true` 与 `y_prob`，输出 `auc/pr_auc/f1/brier/ece/confusion_matrix`。
4. `GET /api/algorithm-validation/export/{run_id}`
返回 zip，内容见第 14 节。

## 13. 评估协议（论文可复用）
1. 数据划分：
时间切分优先（防止信息泄漏），禁止随机打乱穿越未来。
2. 对比组：
`旧算法`、`新算法（全模块）`、`新算法-消融版本（去 RSI/BRI/ASI）`。
3. 指标体系：
分类性能（AUC/PR-AUC/F1/Recall）、概率质量（Brier/ECE）、工程代价（误报率/漏报率）。
4. 统计显著性：
按周或按工作面做 bootstrap 置信区间（95% CI）。
5. 结果陈述模板：
“新算法在 AUC 上提升 x%，Brier 降低 y%，且在高风险召回上提升 z%”。

## 14. 导出包规范（复现实验）
1. `manifest.json`：run_id、算法版本、git commit、时间戳、数据摘要。
2. `config.json`：完整参数快照与阈值策略。
3. `metrics.json`：全部 KPI 与置信区间。
4. `figures/`：`fig1.svg ... fig8.svg`，附同名 `png` 备份。
5. `tables/`：`table1.csv table2.csv table3.csv`。
6. `logs/`：运行日志与异常日志。

## 15. 论文风视觉与标注规范
1. 字体建议：中文 `Noto Serif SC`，英文与公式 `Times New Roman` 风格。
2. 色彩建议：主色黑灰，强调色仅用于风险分级（绿/橙/红），避免高饱和渐变。
3. 线宽与字号：
坐标轴线宽 1.2~1.5px，正文 14~16px，图注 12~13px。
4. 图注格式统一：
`Fig.X | 标题。简要解释输入、方法、结论。`
5. 表格规范：
三线表风格，单位统一写在列名中，不在单元格重复。

## 16. 首轮实施任务拆解（下一步可直接开工）
1. 前端任务：
创建 `AlgorithmValidation.vue` 页面骨架 + 路由 + 侧栏入口。
2. 后端任务：
新增 `/api/algorithm-validation/run` 与 `/result/{run_id}` 最小闭环接口。
3. 联调任务：
前端点击运行 -> 返回 run_id -> 轮询结果 -> 渲染 KPI 卡片与 Fig.1。
4. 验证任务：
使用一份真实数据跑通闭环，生成首个 `run_id` 与导出包。

## 17. 风险与缓解
1. 风险：双后端端口导致调用混乱。
缓解：实施前统一到 `:8001`，前端仅保留一个 API base。
2. 风险：真实数据字段不完整导致计算失败。
缓解：运行前做字段完整性预检查并提示补全模板。
3. 风险：图表多导致页面性能下降。
缓解：折叠区懒加载，图表进入视口再初始化。
4. 风险：结果不可复现。
缓解：强制记录参数快照、版本号、运行日志与随机种子（若使用随机过程）。

## 18. 实施默认决策（无额外讨论可直接执行）
1. 架构默认：单后端优先。新算法实证接口并入 `backend/app/main.py` 所在服务（`:8001`）。
2. 运行默认：首版同步执行（请求内完成），后续再升级异步任务队列。
3. 数据默认：先对接当前可用真实数据集，不等全量数据完美再启动开发。
4. 图表默认：先完成 Fig.1、Fig.5、Fig.6 三张关键图，其他图第二阶段补齐。
5. 评估默认：首版至少包含 `AUC + F1 + Brier + 混淆矩阵`。
6. 导出默认：首版导出 `config.json + metrics.json + fig1.svg + fig6.svg`，第二阶段扩展完整 zip。
