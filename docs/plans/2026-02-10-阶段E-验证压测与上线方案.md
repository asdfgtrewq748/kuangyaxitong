# 阶段 E 实施方案：验证、压测与上线

## 1. 阶段目标

1. 对地质建模融合后的关键链路进行系统级验证。  
2. 建立性能基线与容量边界，形成可发布证据。  
3. 完成上线、监控、回滚与运维交接。

---

## 2. 验证范围

核心链路：
1. 数据导入 -> 建模作业 -> 产物生成 -> MPI 计算。  
2. MPI 计算 -> 实证对照 -> 研究工作台证据包导出。  
3. 前端核心页面（插值、模拟、实证、报告）联调。

覆盖维度：
1. 功能正确性。  
2. 性能与容量。  
3. 稳定性与可观测性。  
4. 发布可回滚性。

---

## 3. 测试与验证清单

### 3.1 后端验证
1. 接口回归：
- `POST /api/geomodel/jobs`
- `GET /api/geomodel/jobs/{job_id}`
- `POST /api/mpi/calculate`
- `POST /api/mpi/calculate-geo`
- 研究与报告相关接口

2. 作业链路验证：
- 正常任务
- 参数异常任务
- 依赖缺失任务
- 大网格长任务

3. 数据一致性验证：
- `summary.json`、`quality_report.json` 与前端展示字段一致。

### 3.2 前端验证
1. 页面渲染回归（桌面/移动常见分辨率）。  
2. 2D/3D 联动正确性（点选、高亮、剖切、图层开关）。  
3. geology-aware 对照页可稳定展示并导出。

### 3.3 科研闭环验证
1. 至少 2 套样本运行完整实验模板。  
2. 导出证据包字段完整且可复现。  
3. 论文图组生成质量可用。

---

## 4. 压测方案

## 4.1 压测对象
1. 建模作业创建与状态轮询接口。  
2. 大产物下载接口。  
3. MPI geology-aware 批量计算。

## 4.2 场景设计
1. 低并发稳态：5-10 并发。  
2. 中并发业务峰值：20-30 并发。  
3. 突发冲击：短时 2-3 倍峰值流量。  
4. 长稳场景：持续 30-60 分钟压力。

## 4.3 指标门槛（建议）
1. 接口成功率 >= 99%。  
2. 核心接口 P95 延迟达标（按链路设定）。  
3. 建模任务失败率可控且可定位。  
4. 无明显内存泄漏与任务积压失控。

---

## 5. 发布与回滚策略

1. 发布策略：
- 灰度发布（先小流量启用 Geomodel 增强功能）。
- 双通道保底（baseline 与 geology-aware 可切换）。

2. 回滚策略：
- 保留旧接口路径与旧计算逻辑。
- 一键关闭 geology-aware 开关。
- 作业队列异常时可降级为仅 baseline 计算。

3. 发布检查单：
- 配置项检查
- 依赖检查
- 数据目录与权限检查
- 监控告警检查
- 回滚演练记录

---

## 6. 可观测性与运维交接

1. 日志：
- job_id、dataset_version、algorithm_mode、错误码、耗时。

2. 监控：
- 接口成功率/延迟
- 队列积压长度
- 作业平均耗时
- 证据包导出成功率

3. 告警：
- 连续失败告警
- 延迟突增告警
- 队列积压告警

4. 运维文档：
- 常见故障排查
- 降级与回滚流程
- 日常巡检项

---

## 7. 阶段验收标准

1. 核心链路回归通过。  
2. 压测结果达到预设阈值。  
3. 上线检查单全部通过并有回滚演练证据。  
4. 运维交接文档完整。

---

## 8. 交付物

1. 压测报告与性能基线报告。  
2. 上线检查清单与回滚演练记录。  
3. 监控告警配置说明。  
4. 阶段 E 验收记录。
