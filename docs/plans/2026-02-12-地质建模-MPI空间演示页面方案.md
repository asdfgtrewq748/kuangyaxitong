# 地质建模 × MPI 空间演示页面方案（独立页面）

## 1. 目标与定位

当前系统已实现 Geomodel 作业、MPI geology-aware 计算、实证与证据包导出，但空间表达仍分散在多个页面。  
本方案新增一个独立页面，把“地质模型 + MPI 总指标 + RSI/BRI/ASI 子指标”放在同一空间上下文中联动展示。

页面定位：
1. 生产侧：快速判断“哪里风险高、为什么高、是否由地质结构驱动”。
2. 科研侧：直观展示“机制链路”（地层结构 -> 子指标变化 -> MPI 变化），支持论文图组输出。

建议页面名称：`地质-指标空间实验室（Geo-MPI Studio）`  
建议路由：`/geo-mpi-studio`

---

## 2. 核心效果（要达到什么）

1. 同屏联动
- 左侧控制区 + 中部 2D 指标矩阵 + 右侧 3D 地层视图同屏。
- 选中任一点后，四张指标图（MPI/RSI/BRI/ASI）与 3D 剖切同步高亮。

2. 双模式对照
- 支持 `baseline` 与 `geology-aware` 一键切换。
- 支持 `delta` 差值图（geo-aware - baseline）显示地质增强收益或风险放大区。

3. 可解释链路
- 点击网格点即可显示：地层特征、关键层跨度、连续性、尖灭比例、RSI/BRI/ASI 贡献占比。
- 展示“指标分解条形图 + 文本解释卡”，避免只给热力图不解释。

4. 科研导出
- 一键导出当前视图图组：`2D 四图 + 3D 截图 + 指标分解图 + 参数快照`。
- 自动生成可复现实验元数据（dataset_version、split_id、geomodel_job_id、参数）。

---

## 3. 页面信息架构与交互设计

## 3.1 布局结构

1. 顶部状态栏
- 当前煤层、Geomodel 任务状态、模式（baseline/geo-aware）、数据版本标签。

2. 左侧控制面板
- 数据输入：`seam`、`geomodel_job_id`、插值分辨率、方法（idw/linear/nearest）。
- 模式控制：baseline / geo-aware / delta。
- 分析工具：剖线、区域框选、阈值分级（高/中/低风险）。

3. 中央可视化区（2x2 矩阵）
- 左上：MPI 空间图
- 右上：RSI 空间图
- 左下：BRI 空间图
- 右下：ASI 空间图

4. 右侧解释区
- 3D 地层视图（图层开关、透明度、剖切）
- 点位解释卡（坐标、地层特征、四指标值、贡献占比）
- baseline vs geo-aware 对照卡（均值/方差/高风险面积变化）

## 3.2 关键交互

1. 点选联动：任一图点选后，四图 + 3D + 解释卡同步。
2. 刷选联动：框选区域后，统计该区域的均值、分位数、风险占比。
3. 剖线分析：在 2D 图绘制剖线，右侧显示沿线四指标剖面曲线。
4. 模式切换：baseline/geo-aware/delta 切换时保持相同色标范围，保证可比性。

---

## 4. 后端与接口方案（实现怎么做）

## 4.1 复用接口

1. `GET /api/geomodel/jobs/{job_id}`
2. `POST /api/mpi/interpolate`
3. `POST /api/mpi/interpolate-geo`

## 4.2 新增接口（建议）

1. `POST /api/mpi/interpolate-geo-breakdown`
- 输入：points、resolution、method、geomodel_job_id
- 输出：
  - `baseline`: `mpi/rsi/bri/asi` 四个 grid + statistics
  - `geo_aware`: `mpi/rsi/bri/asi` 四个 grid + statistics
  - `delta`: 四个 grid
  - `feature_trace_summary`: 连续性/尖灭/层厚变异等摘要

2. `POST /api/mpi/profile`
- 输入：剖线坐标序列 + mode
- 输出：沿线采样点的 MPI/RSI/BRI/ASI 序列

3. `POST /api/research/figures/geo-mpi-snapshot`
- 输入：当前页面状态快照（参数、色标、模式、选区）
- 输出：导出图组与元数据清单（供证据包复用）

---

## 5. 前端实现方案（模块级执行）

## 模块 P1：新页面骨架与路由
1. 新增 `frontend/src/views/GeoMpiStudio.vue`
2. 路由注册 `/geo-mpi-studio`
3. 导航入口与权限控制

验收：页面可访问，基础布局可用。

## 模块 P2：统一状态与数据流
1. 新增 `useGeoMpiStudioState`（参数、模式、选区、点位）
2. 新增 `useGeoMpiData`（接口请求、缓存、错误处理）
3. 与 `useGeomodelJob` 协同（作业状态轮询）

验收：参数变化可触发四图刷新且状态一致。

## 模块 P3：2D 四图矩阵
1. `GeoMpiMapMatrix.vue`（MPI/RSI/BRI/ASI）
2. 共用色标与图例规范（支持锁定范围）
3. 点选/框选事件上抛

验收：四图联动稳定，无错位。

## 模块 P4：3D 地层联动与解释面板
1. `GeomodelLayerViewer.vue` 扩展为联动模式
2. `GeoMpiExplainPanel.vue`（指标分解+特征解释）
3. 剖线与点位同步高亮

验收：点位跨 2D/3D 同步，解释信息完整。

## 模块 P5：导出与科研对接
1. 页面快照导出（PNG/SVG + JSON）
2. 一键推送到 ResearchWorkbench 作为对比输入
3. 证据包附录模板整合

验收：导出内容可直接进入论文图组流程。

---

## 6. 视觉设计方向（是什么样）

1. 风格：工程仪表盘 + 科研分析混合风格，强调“对照”和“解释”。
2. 颜色语义：
- MPI：青绿渐变（高值更稳定）
- RSI/BRI/ASI：分别使用可区分但不冲突的三套色带
- delta：红蓝发散色带（正负变化直观）
3. 层级策略：
- 默认显示“结论视图”（MPI+风险分区+简要解释）
- 展开“专家视图”后显示四图矩阵、剖线、特征轨迹
4. 动效策略：
- 模式切换与联动高亮使用 200~300ms 过渡
- 防止炫技动画，优先保证读图准确性

---

## 7. 科研价值与业务价值

1. 科研价值
- 将“地质结构影响”从文字描述变成可视证据链。
- 支持子指标机制分析，提高论文图表说服力与可复审性。

2. 业务价值
- 缩短专家定位高风险区与解释原因的时间。
- 降低跨页面切换成本，提升现场决策效率。

---

## 8. 验收标准（页面级）

1. 功能验收
- baseline/geo-aware/delta 三模式可切换且结果一致性正确。
- MPI/RSI/BRI/ASI 四图可联动，点选和框选稳定。

2. 性能验收
- 100x100 网格下首屏渲染可控（目标 < 2s，本地基线）。
- 模式切换与交互响应无明显卡顿。

3. 结果验收
- 导出图组与元数据可复现当前页面状态。
- 与 ResearchWorkbench 证据链可无缝衔接。

4. 回归验收
- Playwright 回归新增本页面主流程脚本并纳入阶段 E 清单。

---

## 9. 风险与应对

1. 四图并发渲染压力大
- 方案：渐进渲染 + WebWorker + 缓存 key（mode+resolution+job_id）

2. 2D/3D 坐标映射错位
- 方案：统一坐标转换模块，加入自动对齐校验

3. 信息密度过高导致可用性下降
- 方案：默认简版，专家区折叠；关键结论优先展示

---

## 10. 当前进度（更新于 2026-02-13）
- [x] P1：新页面骨架与路由完成（/geo-mpi-studio）
- [x] P2：统一状态与数据流完成（useGeoMpiStudioState、useGeoMpiData）
- [x] P3：2D 四图矩阵接入真实数据（MPI/RSI/BRI/ASI，支持 baseline/geo-aware/delta）
- [x] P3 后端接口扩展完成：POST /api/mpi/interpolate-geo 新增 include_component_grids 与四指标网格返回
- [x] P3 自动化回归通过（Playwright）：
  - data/research/stage_e/ui_regression/20260213_212304/report.md
  - data/research/stage_e/ui_regression/geo_mpi_studio_20260213_212242/result.txt
- [x] P4 阶段 1：矩阵选点 -> 解释面板联动（含 Geomodel 质量与产物上下文）
- [x] P4 阶段 2：矩阵选点 -> 伪3D 空间锚点联动（Anchor + X/Y + Z-depth）
- [ ] P4 阶段 3：真实 3D 地层剖切/剖线联动
- [ ] P5：导出与科研对接
