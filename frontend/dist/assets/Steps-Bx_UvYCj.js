var M=(ce,k,b)=>new Promise((U,$)=>{var z=_=>{try{V(b.next(_))}catch(N){$(N)}},T=_=>{try{V(b.throw(_))}catch(N){$(N)}},V=_=>_.done?U(_.value):Promise.resolve(_.value).then(z,T);V((b=b.apply(ce,k)).next())});import{w as H,bf as Ce,b8 as m,b7 as t,bi as w,bo as f,bb as v,br as g,bu as Q,bs as R,bc as pe,b9 as me,bt as Le,b6 as Se,b as u,c as ie,b5 as p,ba as Ee}from"./vendor-CcQzWQKD.js";import{_ as ze,a as Te}from"./index-DAAno9XI.js";import{H as xe}from"./HeatmapCanvas-CFQWyIbL.js";import{a as je,L as Ae,M as Oe,N as qe,O as He,P as Qe,d as De,t as Je,o as We,r as Ke}from"./api-PFloj90e.js";import"./vue-router-4_hPxHr_.js";import"./network-T6nY3V_4.js";const Xe={class:"steps-page"},Ye={class:"hero card"},Ze={class:"hero-actions"},et=["disabled"],tt={key:0,class:"spinner"},lt=["disabled"],st=["disabled"],at={class:"card params-card"},nt={class:"params-grid"},ot={key:0},ut=["disabled"],it=["value"],rt={class:"geo-toggle"},dt={class:"geo-toggle-line"},vt={key:1},pt={class:"card kpi-card"},mt={class:"kpi-grid"},ct={class:"kpi-item"},bt={key:0},ft={class:"kpi-item"},gt={key:0},yt={class:"kpi-item"},_t={key:0},kt={class:"kpi-item"},ht={key:0},Mt={key:0,class:"hint"},wt={class:"two-col"},St={class:"card panel"},xt={class:"panel-head"},Nt={class:"tag"},Pt={class:"panel-body"},Ut={key:0,class:"loading-block"},It={key:2,class:"empty-block"},Ft={class:"card panel"},Vt={class:"panel-head"},Gt={class:"tag"},Rt={class:"panel-body"},$t={key:0,class:"loading-block"},Bt={key:2,class:"empty-block"},Ct={class:"stats-row"},Lt={class:"stat-item"},Et={class:"stat-item"},zt={class:"stat-item"},Tt={class:"suggestion"},jt={key:3,class:"geo-summary"},At={class:"stats-row geo-summary-row"},Ot={class:"stat-item"},qt={class:"stat-item"},Ht={class:"stat-item"},Qt={class:"geo-meta"},Dt={key:0,class:"geo-feature"},Jt={key:4,class:"zone-card"},Wt={class:"zone-grid"},Kt={class:"card panel"},Xt={class:"panel-body"},Yt={key:0,class:"loading-block"},Zt={key:1,class:"table-wrap"},el={key:0,class:"table-foot"},tl={key:2,class:"empty-block"},ll={__name:"Steps",setup(ce){const k=Te(),b=u("fixed"),U=u("initial"),$=u(10),z=u(1),T=u(2),V=u(1),_=u("total"),N=u("density_thickness"),D=u(1),j=u(60),A=u([]),S=u(""),J=u(60),W=u("idw"),G=u(!1),K=u(""),X=u(!1),B=u(!1),ee=u(!1),re=u(!1),te=u(!1),le=u(!1),de=u(null),se=u(null),C=u(null),L=u(null),I=u({}),y=u(null),ae=u(""),ne=u(""),oe=u(""),E=u(""),ue=new Map,x=(l,e=2,a="")=>{const s=Number(l);return Number.isFinite(s)?`${s.toFixed(e)}${a?` ${a}`:""}`:"-"},Ne=ie(()=>{var e,a,s,o,r,d;const l=Number((e=I.value)==null?void 0:e.mean);if(!Number.isFinite(l))return"暂无建议，等待MPI结果自动计算完成。";if(G.value&&y.value){const c=Number((s=(a=y.value)==null?void 0:a.baseline_statistics)==null?void 0:s.mean),h=Number((r=(o=y.value)==null?void 0:o.geology_aware_statistics)==null?void 0:r.mean)-c;return(d=y.value)!=null&&d.fallback_used?"地质约束已开启，但当前任务ID不可用或特征缺失，系统已回退默认特征；建议核查建模任务状态。":Number.isFinite(h)&&h<=-3?`地质约束后MPI均值下降 ${h.toFixed(2)}，建议缩小步距并加强低值区支护。`:Number.isFinite(h)&&h>=3?`地质约束后MPI均值上升 ${h.toFixed(2)}，整体可维持当前步距并优化巡检资源投入。`:"地质约束前后差异较小，建议维持当前步距并持续监测局部异常区。"}return l<60?"MPI偏低，建议适当减小步距并提高支护强度。":l<80?"MPI中等，建议按当前步距执行并重点监测局部异常区。":"MPI较高，整体风险较低，可在安全条件下适度增大步距。"}),O=ie(()=>{var a,s,o,r,d,c;if(!y.value)return null;const l=Number((s=(a=y.value)==null?void 0:a.baseline_statistics)==null?void 0:s.mean),e=Number((r=(o=y.value)==null?void 0:o.geology_aware_statistics)==null?void 0:r.mean);return!Number.isFinite(l)||!Number.isFinite(e)?null:{baselineMean:l,geoMean:e,delta:e-l,fallbackUsed:!!((d=y.value)!=null&&d.fallback_used),algorithmMode:((c=y.value)==null?void 0:c.algorithm_mode)||"unknown"}}),be=ie(()=>{var d,c;const l=(c=(d=y.value)==null?void 0:d.feature_trace)==null?void 0:c.features;if(!l)return"";const e=Number(l.continuity_score),a=Number(l.pinchout_ratio),s=Number(l.layer_cv),o=Number(l.key_layer_span),r=[];return Number.isFinite(e)&&r.push(`连续性=${e.toFixed(3)}`),Number.isFinite(a)&&r.push(`尖灭比例=${a.toFixed(3)}`),Number.isFinite(s)&&r.push(`层厚变异=${s.toFixed(3)}`),Number.isFinite(o)&&r.push(`关键层跨度=${o.toFixed(1)}`),r.length?`特征引用：${r.join("，")}`:""}),fe=ie(()=>{const l=L.value;if(!Array.isArray(l)||!l.length)return[];let e=0,a=0,s=0,o=0;for(const d of l)if(Array.isArray(d))for(const c of d){const F=Number(c);Number.isFinite(F)&&(o+=1,F<60?e+=1:F<80?a+=1:s+=1)}if(!o)return[];const r=d=>(d/o*100).toFixed(1);return[{key:"high",label:"高风险区(MPI<60)",count:e,ratio:r(e)},{key:"medium",label:"关注区(60-80)",count:a,ratio:r(a)},{key:"low",label:"低风险区(>=80)",count:s,ratio:r(s)}]}),Y=(l,e=600)=>{let a=null;return()=>{window.clearTimeout(a),a=window.setTimeout(l,e)}},ge=(l=!1)=>M(this,null,function*(){var e,a;ee.value=!0,ae.value="";try{const{data:s}=yield qe(b.value,$.value,z.value,T.value,V.value);de.value=s}catch(s){const o=((a=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:a.detail)||"步距计算失败";ae.value=o,l&&k.add(o,"error")}finally{ee.value=!1}}),ye=(l=!1)=>M(this,null,function*(){var e,a;re.value=!0,ne.value="";try{const{data:s}=yield He(b.value,U.value,_.value,N.value,j.value,D.value);se.value=s}catch(s){const o=((a=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:a.detail)||"步距网格计算失败";ne.value=o,l&&k.add(o,"error")}finally{re.value=!1}}),_e=(l=!1)=>M(this,null,function*(){var e,a;te.value=!0,oe.value="";try{const{data:s}=yield Qe(b.value);C.value=s}catch(s){const o=((a=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:a.detail)||"批量步距计算失败";oe.value=o,l&&k.add(o,"error")}finally{te.value=!1}}),Pe=l=>M(this,null,function*(){if(!l)return null;if(ue.has(l))return ue.get(l);try{const{data:e}=yield Ke(l);return ue.set(l,e),e}catch(e){return ue.set(l,null),null}}),Ue=(...e)=>M(this,[...e],function*(l=[]){var s,o;const a=[];for(const r of l){const d=r.layers||[],c=d.find(P=>P.name===S.value),F=d.filter(P=>P.name!==S.value),h=[];for(const P of F){const i=yield Pe(P.name);h.push({thickness:P.thickness||0,name:P.name||"",density:i==null?void 0:i.density,bulk_modulus:i==null?void 0:i.bulk_modulus,shear_modulus:i==null?void 0:i.shear_modulus,cohesion:i==null?void 0:i.cohesion,friction_angle:i==null?void 0:i.friction_angle,tensile_strength:i==null?void 0:i.tensile_strength,compressive_strength:i==null?void 0:i.compressive_strength,elastic_modulus:i==null?void 0:i.elastic_modulus,poisson_ratio:i==null?void 0:i.poisson_ratio})}const q=(o=(s=r.seam_top_depth)!=null?s:r.total_overburden_thickness)!=null?o:0,Z=(c==null?void 0:c.thickness)||0;a.push({x:r.x,y:r.y,borehole:r.name,thickness:Z,burial_depth:q,z_top:q,z_bottom:q+Z,strata:h})}return a}),ve=(l=!1)=>M(this,null,function*(){var e,a;if(!S.value){L.value=null,I.value={},y.value=null;return}le.value=!0,E.value="",y.value=null;try{const{data:s}=yield De(S.value),o=(s==null?void 0:s.boreholes)||[];if(!o.length){L.value=null,I.value={},y.value=null,E.value="当前煤层没有可用钻孔数据",l&&k.add(E.value,"warning");return}const r=yield Ue(o);if(G.value){const d={points:r,resolution:J.value,method:W.value};K.value&&(d.geomodel_job_id=K.value);const{data:c}=yield Je(d);L.value=(c==null?void 0:c.geology_aware_grid)||null,I.value=(c==null?void 0:c.geology_aware_statistics)||{},y.value=c||null}else{const{data:d}=yield We(r,J.value,W.value);L.value=(d==null?void 0:d.grid)||null,I.value=(d==null?void 0:d.statistics)||{}}}catch(s){const o=((a=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:a.detail)||"MPI分布计算失败";E.value=o,l&&k.add(o,"error")}finally{le.value=!1}}),ke=(l=!1)=>M(this,null,function*(){X.value=!0,yield Promise.all([ge(l),ye(l),_e(l),ve(l)]),X.value=!1,l&&k.add("全部结果已刷新","success")}),Ie=()=>M(this,null,function*(){try{const{data:l}=yield Ae(b.value,U.value,_.value,N.value,j.value,D.value),e=URL.createObjectURL(l),a=document.createElement("a");a.href=e,a.download=`pressure_steps_grid_${b.value}_${U.value}_${j.value}.csv`,a.click(),URL.revokeObjectURL(e),k.add("步距网格导出成功","success")}catch(l){k.add("步距网格导出失败","error")}}),Fe=()=>M(this,null,function*(){try{const{data:l}=yield Oe(b.value),e=URL.createObjectURL(l),a=document.createElement("a");a.href=e,a.download=`pressure_steps_${b.value}.csv`,a.click(),URL.revokeObjectURL(e),k.add("批量结果导出成功","success")}catch(l){k.add("批量结果导出失败","error")}}),Ve=()=>M(this,null,function*(){try{const{data:l}=yield je();A.value=(l==null?void 0:l.seams)||[],!S.value&&A.value.length&&(S.value=A.value[0].name)}catch(l){A.value=[],S.value="",E.value="煤层列表加载失败"}}),Ge=Y(()=>ge(!1),500),Re=Y(()=>ye(!1),650),$e=Y(()=>_e(!1),650),he=Y(()=>ve(!1),700),Be=Y(()=>ve(!1),900);return H([b,$,z,T,V],()=>{B.value&&Ge()}),H([b,U,_,N,D,j],()=>{B.value&&Re()}),H(b,()=>{B.value&&$e()}),H([S,J,W],()=>{B.value&&he()}),H(G,()=>{B.value&&he()}),H(K,()=>{!B.value||!G.value||Be()}),Ce(()=>M(this,null,function*(){yield Ve(),B.value=!0,yield ke(!1)})),(l,e)=>{var a,s,o,r,d,c,F,h,q,Z,P,i,Me;return p(),m("div",Xe,[t("header",Ye,[e[16]||(e[16]=t("div",null,[t("h1",null,"来压步距智能计算"),t("p",null,"默认自动计算：进入页面后立即生成步距结果、步距网格、MPI分布和批量统计。")],-1)),t("div",Ze,[t("button",{class:"btn primary",disabled:X.value,onClick:e[0]||(e[0]=n=>ke(!0))},[X.value?(p(),m("span",tt)):w("",!0),f(" "+v(X.value?"刷新中...":"刷新全部结果"),1)],8,et),t("button",{class:"btn secondary",disabled:!se.value,onClick:Ie},"导出步距网格",8,lt),t("button",{class:"btn secondary",disabled:!C.value,onClick:Fe},"导出批量结果",8,st)])]),t("section",at,[e[37]||(e[37]=t("h2",null,"参数设置",-1)),t("div",nt,[t("label",null,[e[18]||(e[18]=f(" 力学模型 ",-1)),g(t("select",{"onUpdate:modelValue":e[1]||(e[1]=n=>b.value=n)},[...e[17]||(e[17]=[t("option",{value:"fixed"},"固支梁模型",-1),t("option",{value:"simply"},"简支梁模型",-1),t("option",{value:"shear"},"剪切破坏模型",-1),t("option",{value:"empirical"},"经验比例模型",-1)])],512),[[Q,b.value]])]),t("label",null,[e[20]||(e[20]=f(" 计算目标 ",-1)),g(t("select",{"onUpdate:modelValue":e[2]||(e[2]=n=>U.value=n)},[...e[19]||(e[19]=[t("option",{value:"initial"},"初次来压步距",-1),t("option",{value:"periodic"},"周期来压步距",-1)])],512),[[Q,U.value]])]),t("label",null,[e[21]||(e[21]=f(" 顶板厚度 h (m) ",-1)),g(t("input",{"onUpdate:modelValue":e[3]||(e[3]=n=>$.value=n),type:"number",step:"0.1",min:"0.1"},null,512),[[R,$.value,void 0,{number:!0}]])]),t("label",null,[e[22]||(e[22]=f(" 载荷 q (MPa) ",-1)),g(t("input",{"onUpdate:modelValue":e[4]||(e[4]=n=>z.value=n),type:"number",step:"0.1",min:"0.1"},null,512),[[R,z.value,void 0,{number:!0}]])]),t("label",null,[e[23]||(e[23]=f(" 抗拉强度 t (MPa) ",-1)),g(t("input",{"onUpdate:modelValue":e[5]||(e[5]=n=>T.value=n),type:"number",step:"0.1",min:"0.1"},null,512),[[R,T.value,void 0,{number:!0}]])]),t("label",null,[e[24]||(e[24]=f(" 抗剪强度 s (MPa) ",-1)),g(t("input",{"onUpdate:modelValue":e[6]||(e[6]=n=>V.value=n),type:"number",step:"0.1",min:"0.1"},null,512),[[R,V.value,void 0,{number:!0}]])]),t("label",null,[e[26]||(e[26]=f(" h取值 ",-1)),g(t("select",{"onUpdate:modelValue":e[7]||(e[7]=n=>_.value=n)},[...e[25]||(e[25]=[t("option",{value:"total"},"总厚度",-1)])],512),[[Q,_.value]])]),t("label",null,[e[28]||(e[28]=f(" q取值 ",-1)),g(t("select",{"onUpdate:modelValue":e[8]||(e[8]=n=>N.value=n)},[...e[27]||(e[27]=[t("option",{value:"density_thickness"},"容重 × 厚度",-1),t("option",{value:"default"},"默认值",-1)])],512),[[Q,N.value]])]),N.value==="default"?(p(),m("label",ot,[e[29]||(e[29]=f(" 默认q ",-1)),g(t("input",{"onUpdate:modelValue":e[9]||(e[9]=n=>D.value=n),type:"number",step:"0.1",min:"0.1"},null,512),[[R,D.value,void 0,{number:!0}]])])):w("",!0),t("label",null,[e[30]||(e[30]=f(" 网格大小 ",-1)),g(t("input",{"onUpdate:modelValue":e[10]||(e[10]=n=>j.value=n),type:"number",min:"20",max:"120",step:"1"},null,512),[[R,j.value,void 0,{number:!0}]])]),t("label",null,[e[31]||(e[31]=f(" MPI煤层 ",-1)),g(t("select",{"onUpdate:modelValue":e[11]||(e[11]=n=>S.value=n),disabled:A.value.length===0},[(p(!0),m(pe,null,me(A.value,n=>(p(),m("option",{key:n.name,value:n.name},v(n.name),9,it))),128))],8,ut),[[Q,S.value]])]),t("label",null,[e[32]||(e[32]=f(" MPI网格 ",-1)),g(t("input",{"onUpdate:modelValue":e[12]||(e[12]=n=>J.value=n),type:"number",min:"20",max:"150",step:"1"},null,512),[[R,J.value,void 0,{number:!0}]])]),t("label",null,[e[34]||(e[34]=f(" MPI插值 ",-1)),g(t("select",{"onUpdate:modelValue":e[13]||(e[13]=n=>W.value=n)},[...e[33]||(e[33]=[t("option",{value:"idw"},"IDW",-1),t("option",{value:"linear"},"Linear",-1),t("option",{value:"nearest"},"Nearest",-1)])],512),[[Q,W.value]])]),t("label",rt,[e[35]||(e[35]=f(" 地质约束 ",-1)),t("span",dt,[g(t("input",{"onUpdate:modelValue":e[14]||(e[14]=n=>G.value=n),type:"checkbox"},null,512),[[Le,G.value]]),t("span",null,v(G.value?"已开启":"未开启"),1)])]),G.value?(p(),m("label",vt,[e[36]||(e[36]=f(" Geomodel任务ID（可选） ",-1)),g(t("input",{"onUpdate:modelValue":e[15]||(e[15]=n=>K.value=n),type:"text",placeholder:"例如 gm_20260210_xxx"},null,512),[[R,K.value,void 0,{trim:!0}]])])):w("",!0)])]),t("section",pt,[e[42]||(e[42]=t("h2",null,"核心结果总览",-1)),t("div",mt,[t("article",ct,[e[38]||(e[38]=t("span",null,"初次来压步距",-1)),t("strong",null,v(x((a=de.value)==null?void 0:a.initial_step,2,"m")),1),ee.value?(p(),m("small",bt,"自动计算中...")):w("",!0)]),t("article",ft,[e[39]||(e[39]=t("span",null,"周期来压步距",-1)),t("strong",null,v(x((s=de.value)==null?void 0:s.periodic_step,2,"m")),1),ee.value?(p(),m("small",gt,"自动计算中...")):w("",!0)]),t("article",yt,[e[40]||(e[40]=t("span",null,"MPI均值",-1)),t("strong",null,v(x((o=I.value)==null?void 0:o.mean,2)),1),le.value?(p(),m("small",_t,"自动计算中...")):w("",!0)]),t("article",kt,[e[41]||(e[41]=t("span",null,"批量样本数",-1)),t("strong",null,v(((d=(r=C.value)==null?void 0:r.items)==null?void 0:d.length)||0),1),te.value?(p(),m("small",ht,"自动计算中...")):w("",!0)])]),ae.value||ne.value||oe.value||E.value?(p(),m("p",Mt,v(ae.value||ne.value||oe.value||E.value),1)):w("",!0)]),t("section",wt,[t("article",St,[t("div",xt,[e[43]||(e[43]=t("h3",null,"步距分布网格",-1)),t("span",Nt,v(b.value)+" / "+v(U.value),1)]),t("div",Pt,[re.value?(p(),m("div",Ut,"正在自动计算步距网格...")):(F=(c=se.value)==null?void 0:c.values)!=null&&F.length?(p(),Se(xe,{key:1,grid:se.value.values,size:480},null,8,["grid"])):(p(),m("div",It,"暂无网格数据"))])]),t("article",Ft,[t("div",Vt,[e[44]||(e[44]=t("h3",null,"MPI分布与步距建议",-1)),t("span",Gt,v(S.value||"未选择煤层"),1)]),t("div",Rt,[le.value?(p(),m("div",$t,"正在自动计算MPI分布...")):(h=L.value)!=null&&h.length?(p(),Se(xe,{key:1,grid:L.value,size:420},null,8,["grid"])):(p(),m("div",Bt,"暂无MPI分布")),t("div",Ct,[t("div",Lt,[e[45]||(e[45]=t("span",null,"最小值",-1)),t("strong",null,v(x((q=I.value)==null?void 0:q.min,2)),1)]),t("div",Et,[e[46]||(e[46]=t("span",null,"最大值",-1)),t("strong",null,v(x((Z=I.value)==null?void 0:Z.max,2)),1)]),t("div",zt,[e[47]||(e[47]=t("span",null,"平均值",-1)),t("strong",null,v(x((P=I.value)==null?void 0:P.mean,2)),1)])]),t("div",Tt,[e[48]||(e[48]=t("h4",null,"步距建议",-1)),t("p",null,v(Ne.value),1)]),O.value?(p(),m("div",jt,[e[52]||(e[52]=t("h4",null,"地质约束对照",-1)),t("div",At,[t("div",Ot,[e[49]||(e[49]=t("span",null,"Baseline均值",-1)),t("strong",null,v(x(O.value.baselineMean,2)),1)]),t("div",qt,[e[50]||(e[50]=t("span",null,"Geo-aware均值",-1)),t("strong",null,v(x(O.value.geoMean,2)),1)]),t("div",Ht,[e[51]||(e[51]=t("span",null,"均值变化",-1)),t("strong",null,v(x(O.value.delta,2)),1)])]),t("p",Qt," 模式："+v(O.value.algorithmMode)+" · 回退："+v(O.value.fallbackUsed?"是":"否"),1),be.value?(p(),m("p",Dt,v(be.value),1)):w("",!0)])):w("",!0),fe.value.length?(p(),m("div",Jt,[e[53]||(e[53]=t("h4",null,"分区风险说明",-1)),t("div",Wt,[(p(!0),m(pe,null,me(fe.value,n=>(p(),m("div",{key:n.key,class:Ee(["zone-item",n.key])},[t("span",null,v(n.label),1),t("strong",null,v(n.count)+"格 / "+v(n.ratio)+"%",1)],2))),128))])])):w("",!0)])])]),t("section",Kt,[e[55]||(e[55]=t("div",{class:"panel-head"},[t("h3",null,"批量步距结果"),t("span",{class:"tag"},"最多预览前20条")],-1)),t("div",Xt,[te.value?(p(),m("div",Yt,"正在自动计算批量结果...")):(Me=(i=C.value)==null?void 0:i.items)!=null&&Me.length?(p(),m("div",Zt,[t("table",null,[e[54]||(e[54]=t("thead",null,[t("tr",null,[t("th",null,"#"),t("th",null,"初次来压步距 (m)"),t("th",null,"周期来压步距 (m)")])],-1)),t("tbody",null,[(p(!0),m(pe,null,me(C.value.items.slice(0,20),(n,we)=>(p(),m("tr",{key:we},[t("td",null,v(we+1),1),t("td",null,v(x(n.initial,2)),1),t("td",null,v(x(n.periodic,2)),1)]))),128))])]),C.value.items.length>20?(p(),m("div",el,"还有 "+v(C.value.items.length-20)+" 条未展示",1)):w("",!0)])):(p(),m("div",tl,"暂无批量结果"))])])])}}},dl=ze(ll,[["__scopeId","data-v-a5e9383b"]]);export{dl as default};
