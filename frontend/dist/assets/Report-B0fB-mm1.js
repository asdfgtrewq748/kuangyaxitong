var M=(V,R,w)=>new Promise((L,z)=>{var O=i=>{try{m(w.next(i))}catch(f){z(f)}},b=i=>{try{m(w.throw(i))}catch(f){z(f)}},m=i=>i.done?L(i.value):Promise.resolve(i.value).then(O,b);m((w=w.apply(V,R)).next())});import{w as E,bf as st,b8 as r,b7 as t,bi as U,bo as et,bb as l,br as nt,bv as lt,bc as C,b9 as A,ba as at,b as x,b5 as d}from"./vendor-CA5Q5CdR.js";import{u as ot,a as it}from"./vue-router-D9BXaJFq.js";import{_ as ut,u as rt,a as dt}from"./index-oBIkjPyK.js";import{g as ct,x as mt,y as vt,z as pt,A as bt,b as ht,B as _t,l as yt}from"./api-CJun_zz_.js";import"./network-T6nY3V_4.js";const gt={class:"report-page"},ft={class:"card hero"},kt={class:"hero-actions"},St=["disabled"],Pt={key:0,class:"spinner"},xt=["disabled"],wt={class:"card controls"},Mt={class:"control-item"},It=["disabled"],Rt=["value"],zt={class:"control-item status"},Dt={class:"control-item status"},Ct={key:0,class:"card"},At={class:"error"},Bt={class:"card"},Lt={key:0,class:"cards-grid"},Ot={class:"metric-main"},Tt={class:"metric-sub"},Vt={class:"metric-sub"},jt={key:1,class:"empty-block"},Ft={class:"card"},$t={key:0,class:"mpi-layout"},Et={class:"mpi-stats"},Ut={class:"stat-item"},Nt={class:"stat-item"},qt={class:"stat-item"},Qt={class:"stat-item"},Wt={class:"stat-item"},Gt={class:"stat-item"},Ht={class:"stat-item"},Jt={class:"mpi-extremes"},Kt={key:1,class:"empty-block"},Xt={class:"card"},Yt={key:0,class:"table-wrap"},Zt={key:1,class:"empty-block"},ts={__name:"Report",setup(V){const R=dt(),w=ot(),L=it(),{setSelectedSeam:z,markStepDone:O}=rt(),b=x(!1),m=x([]),i=x(null),f=x(""),j=x(""),D=x([]),h=x(""),F=x(!1),B=new Map,a=(n,s=3)=>{const e=Number(n);return Number.isFinite(e)?e.toFixed(s):"-"},$=n=>Array.isArray(n)?n[0]||"":typeof n=="string"?n:"",N=()=>M(this,null,function*(){var n,s;try{const{data:e}=yield ct();D.value=(e==null?void 0:e.seams)||[];const c=$((n=w.query)==null?void 0:n.seam)||((s=D.value[0])==null?void 0:s.name)||"";h.value=c,c&&z(c)}catch(e){D.value=[],h.value=""}}),q=n=>M(this,null,function*(){if(!n)return null;if(B.has(n))return B.get(n);try{const{data:s}=yield yt(n);return B.set(n,s),s}catch(s){return B.set(n,null),null}}),Q=(...e)=>M(this,[...e],function*(n=[],s=""){var c,p;const v=[];for(const u of n){const _=u.layers||[],k=_.find(g=>g.name===s),S=_.filter(g=>g.name!==s),y=[];for(const g of S){const o=yield q(g.name);y.push({thickness:g.thickness||0,name:g.name||"",density:o==null?void 0:o.density,bulk_modulus:o==null?void 0:o.bulk_modulus,shear_modulus:o==null?void 0:o.shear_modulus,cohesion:o==null?void 0:o.cohesion,friction_angle:o==null?void 0:o.friction_angle,tensile_strength:o==null?void 0:o.tensile_strength,compressive_strength:o==null?void 0:o.compressive_strength,elastic_modulus:o==null?void 0:o.elastic_modulus,poisson_ratio:o==null?void 0:o.poisson_ratio})}const P=(p=(c=u.seam_top_depth)!=null?c:u.total_overburden_thickness)!=null?p:0,I=(k==null?void 0:k.thickness)||0;v.push({x:u.x,y:u.y,borehole:u.name,thickness:I,burial_depth:P,z_top:P,z_bottom:P+I,strata:y})}return v}),W=n=>M(this,null,function*(){if(!n)return null;try{const{data:s}=yield ht(n),e=(s==null?void 0:s.boreholes)||[];if(!e.length)return null;const v=yield Q(e,n),{data:c}=yield _t(v),p=(c==null?void 0:c.results)||[];if(!p.length)return null;const u=p.reduce((S,y)=>{var P,I,g;return S.rsi+=((P=y.breakdown)==null?void 0:P.rsi)||0,S.bri+=((I=y.breakdown)==null?void 0:I.bri)||0,S.asi+=((g=y.breakdown)==null?void 0:g.asi)||0,S},{rsi:0,bri:0,asi:0}),_=p.length,k=[...p].sort((S,y)=>S.mpi-y.mpi);return{seamName:n,stats:(c==null?void 0:c.summary)||{},breakdown:{rsi:u.rsi/_,bri:u.bri/_,asi:u.asi/_},high:k.slice(-3).reverse(),low:k.slice(0,3)}}catch(s){return null}}),T=(n=!1)=>M(this,null,function*(){var s,e;b.value=!0,f.value="";try{const v="idw",p="x",_="ascending",k="decrease",y="fixed",P="initial",[K,X,Y,Z,tt]=yield Promise.all([mt(v,60),vt({method:v,grid_size:60,axis:p,count:3,direction:_,mode:k,decay:.08,elastic_modulus:.4,density:.3,tensile_strength:.3}),pt(y,P,60),bt({model:y,target:P,grid_size:60,axis:p,count:3,direction:_,mode:k,decay:.08}),W(h.value)]);m.value=[{name:"矿压指标",stats:K.data.grid},{name:"矿压指标-工作面",stats:X.data.grid},{name:"来压步距",stats:Y.data.grid},{name:"来压步距-工作面",stats:Z.data.grid}],i.value=tt,j.value=new Date().toLocaleString(),O("Report",{reportGeneratedAt:new Date().toISOString()}),n&&R.add("报告已刷新","success")}catch(v){f.value=((e=(s=v==null?void 0:v.response)==null?void 0:s.data)==null?void 0:e.detail)||"报告生成失败",n&&R.add(f.value,"error")}finally{b.value=!1}}),G=()=>{L.push({name:"AlgorithmValidation",query:h.value?{seam:h.value}:void 0})},H=()=>{if(!m.value.length)return;const n=m.value.map(u=>({指标:u.name,最小值:a(u.stats.min,3),最大值:a(u.stats.max,3),平均值:a(u.stats.mean,3),标准差:a(u.stats.std,3),P10:a(u.stats.p10,3),P50:a(u.stats.p50,3),P90:a(u.stats.p90,3)}));i.value&&n.push({指标:`MPI综合指标(${i.value.seamName})`,最小值:a(i.value.stats.min,3),最大值:a(i.value.stats.max,3),平均值:a(i.value.stats.mean,3),标准差:a(i.value.stats.std,3),P10:"",P50:"",P90:""});const s=Object.keys(n[0]),e=[s.join(","),...n.map(u=>s.map(_=>u[_]).join(","))].join(`
`),v=new Blob([e],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(v),p=document.createElement("a");p.href=c,p.download=`pressure_report_${new Date().toISOString().slice(0,10)}.csv`,p.click(),URL.revokeObjectURL(c),R.add("报告导出成功","success")},J=(()=>{let n=null;return()=>{F.value&&(window.clearTimeout(n),n=window.setTimeout(()=>{h.value&&(z(h.value),T(!1))},500))}})();return E(h,()=>{J()}),E(()=>{var n;return(n=w.query)==null?void 0:n.seam},n=>{const s=$(n);s&&s!==h.value&&(h.value=s)}),st(()=>M(this,null,function*(){yield N(),F.value=!0,yield T(!1)})),(n,s)=>(d(),r("div",gt,[t("header",ft,[s[2]||(s[2]=t("div",null,[t("h1",null,"结果报告中心"),t("p",null,"默认自动生成报告，进入页面后立即汇总指标统计、MPI专题分析与明细表。")],-1)),t("div",kt,[t("button",{class:"btn primary",disabled:b.value,onClick:s[0]||(s[0]=e=>T(!0))},[b.value?(d(),r("span",Pt)):U("",!0),et(" "+l(b.value?"刷新中...":"刷新报告"),1)],8,St),t("button",{class:"btn secondary",disabled:!m.value.length,onClick:H},"导出CSV",8,xt),t("button",{class:"btn secondary",onClick:G},"返回实证页")])]),t("section",wt,[t("div",Mt,[s[3]||(s[3]=t("label",null,"专题煤层",-1)),nt(t("select",{"onUpdate:modelValue":s[1]||(s[1]=e=>h.value=e),disabled:!D.value.length},[(d(!0),r(C,null,A(D.value,e=>(d(),r("option",{key:e.name,value:e.name},l(e.name),9,Rt))),128))],8,It),[[lt,h.value]])]),t("div",zt,[s[4]||(s[4]=t("label",null,"报告状态",-1)),t("span",{class:at(["status-chip",b.value?"loading":m.value.length?"ready":"idle"])},l(b.value?"自动计算中":m.value.length?"已生成":"暂无数据"),3)]),t("div",Dt,[s[5]||(s[5]=t("label",null,"最近更新",-1)),t("span",null,l(j.value||"-"),1)])]),f.value?(d(),r("section",Ct,[t("p",At,l(f.value),1)])):U("",!0),t("section",Bt,[s[6]||(s[6]=t("h2",null,"总览统计",-1)),m.value.length?(d(),r("div",Lt,[(d(!0),r(C,null,A(m.value,e=>(d(),r("article",{class:"metric-card",key:e.name},[t("h3",null,l(e.name),1),t("div",Ot,l(a(e.stats.mean,3)),1),t("div",Tt,[t("span",null,"Min "+l(a(e.stats.min,3)),1),t("span",null,"Max "+l(a(e.stats.max,3)),1)]),t("div",Vt,[t("span",null,"Std "+l(a(e.stats.std,3)),1),t("span",null,"P50 "+l(a(e.stats.p50,3)),1)])]))),128))])):(d(),r("div",jt,l(b.value?"正在自动生成总览统计...":"暂无总览统计数据"),1))]),t("section",Ft,[s[16]||(s[16]=t("h2",null,"MPI专题分析",-1)),i.value?(d(),r("div",$t,[t("div",Et,[t("div",Ut,[s[7]||(s[7]=t("span",null,"煤层",-1)),t("strong",null,l(i.value.seamName),1)]),t("div",Nt,[s[8]||(s[8]=t("span",null,"MPI均值",-1)),t("strong",null,l(a(i.value.stats.mean,2)),1)]),t("div",qt,[s[9]||(s[9]=t("span",null,"MPI最小",-1)),t("strong",null,l(a(i.value.stats.min,2)),1)]),t("div",Qt,[s[10]||(s[10]=t("span",null,"MPI最大",-1)),t("strong",null,l(a(i.value.stats.max,2)),1)]),t("div",Wt,[s[11]||(s[11]=t("span",null,"RSI均值",-1)),t("strong",null,l(a(i.value.breakdown.rsi,2)),1)]),t("div",Gt,[s[12]||(s[12]=t("span",null,"BRI均值",-1)),t("strong",null,l(a(i.value.breakdown.bri,2)),1)]),t("div",Ht,[s[13]||(s[13]=t("span",null,"ASI均值",-1)),t("strong",null,l(a(i.value.breakdown.asi,2)),1)])]),t("div",Jt,[t("article",null,[s[14]||(s[14]=t("h3",null,"高MPI区域（低风险）",-1)),t("ul",null,[(d(!0),r(C,null,A(i.value.high,e=>(d(),r("li",{key:`high-${e.id}`},l(e.id)+": "+l(a(e.mpi,2)),1))),128))])]),t("article",null,[s[15]||(s[15]=t("h3",null,"低MPI区域（高风险）",-1)),t("ul",null,[(d(!0),r(C,null,A(i.value.low,e=>(d(),r("li",{key:`low-${e.id}`},l(e.id)+": "+l(a(e.mpi,2)),1))),128))])])])])):(d(),r("div",Kt,l(b.value?"正在自动生成MPI专题分析...":"暂无MPI专题分析数据"),1))]),t("section",Xt,[s[18]||(s[18]=t("h2",null,"详细统计表",-1)),m.value.length?(d(),r("div",Yt,[t("table",null,[s[17]||(s[17]=t("thead",null,[t("tr",null,[t("th",null,"指标"),t("th",null,"最小值"),t("th",null,"最大值"),t("th",null,"平均值"),t("th",null,"标准差"),t("th",null,"P10"),t("th",null,"P50"),t("th",null,"P90")])],-1)),t("tbody",null,[(d(!0),r(C,null,A(m.value,e=>(d(),r("tr",{key:`table-${e.name}`},[t("td",null,l(e.name),1),t("td",null,l(a(e.stats.min,3)),1),t("td",null,l(a(e.stats.max,3)),1),t("td",null,l(a(e.stats.mean,3)),1),t("td",null,l(a(e.stats.std,3)),1),t("td",null,l(a(e.stats.p10,3)),1),t("td",null,l(a(e.stats.p50,3)),1),t("td",null,l(a(e.stats.p90,3)),1)]))),128))])])])):(d(),r("div",Zt,l(b.value?"正在自动生成明细统计...":"暂无明细统计数据"),1))])]))}},is=ut(ts,[["__scopeId","data-v-c5167309"]]);export{is as default};
