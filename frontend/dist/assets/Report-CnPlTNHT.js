var z=(G,D,M)=>new Promise(($,A)=>{var Q=m=>{try{k(M.next(m))}catch(R){A(R)}},S=m=>{try{k(M.throw(m))}catch(R){A(R)}},k=m=>m.done?$(m.value):Promise.resolve(m.value).then(Q,S);k((M=M.apply(G,D)).next())});import{w as F,bf as rt,b8 as d,b7 as t,bi as C,bo as ut,bb as a,br as K,bu as dt,bc as T,b9 as L,ba as ct,bs as mt,b as I,b5 as c}from"./vendor-CcQzWQKD.js";import{u as vt,a as _t}from"./vue-router-4_hPxHr_.js";import{_ as pt,u as gt,a as yt}from"./index-DAAno9XI.js";import{a as ht,Q as bt,R as ft,S as kt,T as wt,g as St,f as xt,d as It,U as Pt,r as Mt}from"./api-PFloj90e.js";import"./network-T6nY3V_4.js";const Rt={class:"report-page"},Dt={class:"card hero"},zt={class:"hero-actions"},Ct=["disabled"],At={key:0,class:"spinner"},qt=["disabled"],Nt={class:"card controls"},Tt={class:"control-item"},Lt=["disabled"],Ot=["value"],Vt={class:"control-item status"},$t={class:"control-item status"},Qt={class:"control-item geomodel-control"},Ut={class:"geomodel-input-row"},Bt=["disabled"],Et={key:0,class:"card"},Ft={class:"error"},Gt={class:"card"},Jt={key:0,class:"cards-grid"},Wt={class:"metric-main"},jt={class:"metric-sub"},Ht={class:"metric-sub"},Kt={key:1,class:"empty-block"},Xt={class:"card"},Yt={key:0,class:"mpi-layout"},Zt={class:"mpi-stats"},ts={class:"stat-item"},ss={class:"stat-item"},es={class:"stat-item"},ns={class:"stat-item"},as={class:"stat-item"},ls={class:"stat-item"},os={class:"stat-item"},is={class:"mpi-extremes"},rs={key:1,class:"empty-block"},us={class:"card"},ds={key:0,class:"error"},cs={key:1,class:"geomodel-quality-grid"},ms={class:"metric-card"},vs={class:"metric-main"},_s={class:"metric-sub"},ps={class:"metric-card"},gs={class:"metric-main"},ys={class:"metric-sub"},hs={class:"metric-card"},bs={class:"metric-main"},fs={class:"metric-sub"},ks={class:"metric-card warning-card"},ws={class:"warning-list"},Ss={key:0},xs={key:1},Is={key:2},Ps={key:3},Ms={key:2,class:"empty-block"},Rs={class:"card"},Ds={key:0,class:"table-wrap"},zs={key:1,class:"empty-block"},Cs={__name:"Report",setup(G){const D=yt(),M=vt(),$=_t(),{setSelectedSeam:A,markStepDone:Q}=gt(),S=I(!1),k=I([]),m=I(null),R=I(""),J=I(""),q=I([]),x=I(""),W=I(!1),P=I(""),b=I(null),O=I(!1),N=I(""),V=new Map,l=(e,s=3)=>{const y=Number(e);return Number.isFinite(y)?y.toFixed(s):"-"},j=e=>Array.isArray(e)?e[0]||"":typeof e=="string"?e:"",U=e=>Array.isArray(e)?e[0]||"":typeof e=="string"?e:"",X=()=>z(this,null,function*(){var e,s,y,_;try{const{data:v}=yield ht();q.value=(v==null?void 0:v.seams)||[];const p=j((e=M.query)==null?void 0:e.seam),o=U((s=M.query)==null?void 0:s.geomodel_job_id)||U((y=M.query)==null?void 0:y.geomodelJobId);o&&(P.value=o);const g=p||((_=q.value[0])==null?void 0:_.name)||"";x.value=g,g&&A(g)}catch(v){q.value=[],x.value=""}}),H=(e=!1)=>z(this,null,function*(){var s,y,_,v,p,o,g,f,n,w;if(N.value="",b.value=null,!!P.value){O.value=!0;try{const{data:r}=yield St(P.value),h=((s=r==null?void 0:r.result_manifest)==null?void 0:s.quality_summary)||{};if((r==null?void 0:r.status)!=="completed"){b.value={status:(r==null?void 0:r.status)||"pending",summary:h,warning_flags:{}},e&&D.add(`建模任务状态：${(r==null?void 0:r.status)||"pending"}`,"warning");return}let u={};try{const E=yield(yield xt(P.value,"quality_report.json")).data.text();u=JSON.parse(E)}catch(i){u={}}b.value={status:(r==null?void 0:r.status)||"completed",summary:{continuity_score:Number((_=(y=h==null?void 0:h.continuity_score)!=null?y:u==null?void 0:u.continuity_score)!=null?_:0),pinchout_ratio:Number((p=(v=h==null?void 0:h.pinchout_ratio)!=null?v:u==null?void 0:u.pinchout_ratio)!=null?p:0),layer_cv:Number((g=(o=h==null?void 0:h.layer_cv)!=null?o:u==null?void 0:u.layer_cv)!=null?g:0),zero_or_negative_ratio:Number((f=u==null?void 0:u.zero_or_negative_ratio)!=null?f:0)},warning_flags:(u==null?void 0:u.warning_flags)||{}},e&&D.add("已加载地质模型质量摘要","success")}catch(r){N.value=((w=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:w.detail)||"读取地质建模质量失败",e&&D.add(N.value,"error")}finally{O.value=!1}}}),Y=e=>z(this,null,function*(){if(!e)return null;if(V.has(e))return V.get(e);try{const{data:s}=yield Mt(e);return V.set(e,s),s}catch(s){return V.set(e,null),null}}),Z=(...y)=>z(this,[...y],function*(e=[],s=""){var v,p;const _=[];for(const o of e){const g=o.layers||[],f=g.find(u=>u.name===s),n=g.filter(u=>u.name!==s),w=[];for(const u of n){const i=yield Y(u.name);w.push({thickness:u.thickness||0,name:u.name||"",density:i==null?void 0:i.density,bulk_modulus:i==null?void 0:i.bulk_modulus,shear_modulus:i==null?void 0:i.shear_modulus,cohesion:i==null?void 0:i.cohesion,friction_angle:i==null?void 0:i.friction_angle,tensile_strength:i==null?void 0:i.tensile_strength,compressive_strength:i==null?void 0:i.compressive_strength,elastic_modulus:i==null?void 0:i.elastic_modulus,poisson_ratio:i==null?void 0:i.poisson_ratio})}const r=(p=(v=o.seam_top_depth)!=null?v:o.total_overburden_thickness)!=null?p:0,h=(f==null?void 0:f.thickness)||0;_.push({x:o.x,y:o.y,borehole:o.name,thickness:h,burial_depth:r,z_top:r,z_bottom:r+h,strata:w})}return _}),tt=e=>z(this,null,function*(){if(!e)return null;try{const{data:s}=yield It(e),y=(s==null?void 0:s.boreholes)||[];if(!y.length)return null;const _=yield Z(y,e),{data:v}=yield Pt(_),p=(v==null?void 0:v.results)||[];if(!p.length)return null;const o=p.reduce((n,w)=>{var r,h,u;return n.rsi+=((r=w.breakdown)==null?void 0:r.rsi)||0,n.bri+=((h=w.breakdown)==null?void 0:h.bri)||0,n.asi+=((u=w.breakdown)==null?void 0:u.asi)||0,n},{rsi:0,bri:0,asi:0}),g=p.length,f=[...p].sort((n,w)=>n.mpi-w.mpi);return{seamName:e,stats:(v==null?void 0:v.summary)||{},breakdown:{rsi:o.rsi/g,bri:o.bri/g,asi:o.asi/g},high:f.slice(-3).reverse(),low:f.slice(0,3)}}catch(s){return null}}),B=(e=!1)=>z(this,null,function*(){var s,y;S.value=!0,R.value="";try{const _="idw",p="x",g="ascending",f="decrease",w="fixed",r="initial",[E,at,lt,ot,it]=yield Promise.all([bt(_,60),ft({method:_,grid_size:60,axis:p,count:3,direction:g,mode:f,decay:.08,elastic_modulus:.4,density:.3,tensile_strength:.3}),kt(w,r,60),wt({model:w,target:r,grid_size:60,axis:p,count:3,direction:g,mode:f,decay:.08}),tt(x.value)]);k.value=[{name:"矿压指标",stats:E.data.grid},{name:"矿压指标-工作面",stats:at.data.grid},{name:"来压步距",stats:lt.data.grid},{name:"来压步距-工作面",stats:ot.data.grid}],m.value=it,J.value=new Date().toLocaleString(),Q("Report",{reportGeneratedAt:new Date().toISOString()}),e&&D.add("报告已刷新","success")}catch(_){R.value=((y=(s=_==null?void 0:_.response)==null?void 0:s.data)==null?void 0:y.detail)||"报告生成失败",e&&D.add(R.value,"error")}finally{S.value=!1}}),st=()=>{$.push({name:"AlgorithmValidation",query:x.value?{seam:x.value}:void 0})},et=()=>{if(!k.value.length)return;const e=k.value.map(o=>({指标:o.name,最小值:l(o.stats.min,3),最大值:l(o.stats.max,3),平均值:l(o.stats.mean,3),标准差:l(o.stats.std,3),P10:l(o.stats.p10,3),P50:l(o.stats.p50,3),P90:l(o.stats.p90,3)}));m.value&&e.push({指标:`MPI综合指标(${m.value.seamName})`,最小值:l(m.value.stats.min,3),最大值:l(m.value.stats.max,3),平均值:l(m.value.stats.mean,3),标准差:l(m.value.stats.std,3),P10:"",P50:"",P90:""});const s=Object.keys(e[0]),y=[s.join(","),...e.map(o=>s.map(g=>o[g]).join(","))].join(`
`),_=new Blob([y],{type:"text/csv;charset=utf-8;"}),v=URL.createObjectURL(_),p=document.createElement("a");p.href=v,p.download=`pressure_report_${new Date().toISOString().slice(0,10)}.csv`,p.click(),URL.revokeObjectURL(v),D.add("报告导出成功","success")},nt=(()=>{let e=null;return()=>{W.value&&(window.clearTimeout(e),e=window.setTimeout(()=>{x.value&&(A(x.value),B(!1))},500))}})();return F(x,()=>{nt()}),F(()=>{var e;return(e=M.query)==null?void 0:e.seam},e=>{const s=j(e);s&&s!==x.value&&(x.value=s)}),F(()=>{var e;return(e=M.query)==null?void 0:e.geomodel_job_id},e=>{const s=U(e);s&&s!==P.value&&(P.value=s)}),rt(()=>z(this,null,function*(){yield X(),W.value=!0,yield B(!1),P.value&&(yield H(!1))})),(e,s)=>{var y,_,v,p,o,g,f;return c(),d("div",Rt,[t("header",Dt,[s[4]||(s[4]=t("div",null,[t("h1",null,"结果报告中心"),t("p",null,"默认自动生成报告，进入页面后立即汇总指标统计、MPI专题分析与明细表。")],-1)),t("div",zt,[t("button",{class:"btn primary",disabled:S.value,onClick:s[0]||(s[0]=n=>B(!0))},[S.value?(c(),d("span",At)):C("",!0),ut(" "+a(S.value?"刷新中...":"刷新报告"),1)],8,Ct),t("button",{class:"btn secondary",disabled:!k.value.length,onClick:et},"导出CSV",8,qt),t("button",{class:"btn secondary",onClick:st},"返回实证页")])]),t("section",Nt,[t("div",Tt,[s[5]||(s[5]=t("label",null,"专题煤层",-1)),K(t("select",{"onUpdate:modelValue":s[1]||(s[1]=n=>x.value=n),disabled:!q.value.length},[(c(!0),d(T,null,L(q.value,n=>(c(),d("option",{key:n.name,value:n.name},a(n.name),9,Ot))),128))],8,Lt),[[dt,x.value]])]),t("div",Vt,[s[6]||(s[6]=t("label",null,"报告状态",-1)),t("span",{class:ct(["status-chip",S.value?"loading":k.value.length?"ready":"idle"])},a(S.value?"自动计算中":k.value.length?"已生成":"暂无数据"),3)]),t("div",$t,[s[7]||(s[7]=t("label",null,"最近更新",-1)),t("span",null,a(J.value||"-"),1)]),t("div",Qt,[s[8]||(s[8]=t("label",null,"Geomodel任务ID",-1)),t("div",Ut,[K(t("input",{"onUpdate:modelValue":s[2]||(s[2]=n=>P.value=n),type:"text",placeholder:"输入任务ID，如 a1b2c3d4e5f6"},null,512),[[mt,P.value,void 0,{trim:!0}]]),t("button",{class:"btn secondary small",disabled:O.value||!P.value,onClick:s[3]||(s[3]=n=>H(!0))},a(O.value?"读取中...":"读取质量"),9,Bt)])])]),R.value?(c(),d("section",Et,[t("p",Ft,a(R.value),1)])):C("",!0),t("section",Gt,[s[9]||(s[9]=t("h2",null,"总览统计",-1)),k.value.length?(c(),d("div",Jt,[(c(!0),d(T,null,L(k.value,n=>(c(),d("article",{class:"metric-card",key:n.name},[t("h3",null,a(n.name),1),t("div",Wt,a(l(n.stats.mean,3)),1),t("div",jt,[t("span",null,"Min "+a(l(n.stats.min,3)),1),t("span",null,"Max "+a(l(n.stats.max,3)),1)]),t("div",Ht,[t("span",null,"Std "+a(l(n.stats.std,3)),1),t("span",null,"P50 "+a(l(n.stats.p50,3)),1)])]))),128))])):(c(),d("div",Kt,a(S.value?"正在自动生成总览统计...":"暂无总览统计数据"),1))]),t("section",Xt,[s[19]||(s[19]=t("h2",null,"MPI专题分析",-1)),m.value?(c(),d("div",Yt,[t("div",Zt,[t("div",ts,[s[10]||(s[10]=t("span",null,"煤层",-1)),t("strong",null,a(m.value.seamName),1)]),t("div",ss,[s[11]||(s[11]=t("span",null,"MPI均值",-1)),t("strong",null,a(l(m.value.stats.mean,2)),1)]),t("div",es,[s[12]||(s[12]=t("span",null,"MPI最小",-1)),t("strong",null,a(l(m.value.stats.min,2)),1)]),t("div",ns,[s[13]||(s[13]=t("span",null,"MPI最大",-1)),t("strong",null,a(l(m.value.stats.max,2)),1)]),t("div",as,[s[14]||(s[14]=t("span",null,"RSI均值",-1)),t("strong",null,a(l(m.value.breakdown.rsi,2)),1)]),t("div",ls,[s[15]||(s[15]=t("span",null,"BRI均值",-1)),t("strong",null,a(l(m.value.breakdown.bri,2)),1)]),t("div",os,[s[16]||(s[16]=t("span",null,"ASI均值",-1)),t("strong",null,a(l(m.value.breakdown.asi,2)),1)])]),t("div",is,[t("article",null,[s[17]||(s[17]=t("h3",null,"高MPI区域（低风险）",-1)),t("ul",null,[(c(!0),d(T,null,L(m.value.high,n=>(c(),d("li",{key:`high-${n.id}`},a(n.id)+": "+a(l(n.mpi,2)),1))),128))])]),t("article",null,[s[18]||(s[18]=t("h3",null,"低MPI区域（高风险）",-1)),t("ul",null,[(c(!0),d(T,null,L(m.value.low,n=>(c(),d("li",{key:`low-${n.id}`},a(n.id)+": "+a(l(n.mpi,2)),1))),128))])])])])):(c(),d("div",rs,a(S.value?"正在自动生成MPI专题分析...":"暂无MPI专题分析数据"),1))]),t("section",us,[s[27]||(s[27]=t("h2",null,"地质模型质量章节",-1)),N.value?(c(),d("div",ds,a(N.value),1)):b.value?(c(),d("div",cs,[t("article",ms,[s[21]||(s[21]=t("h3",null,"任务状态",-1)),t("div",vs,a(b.value.status||"-"),1),t("div",_s,[s[20]||(s[20]=t("span",null,"任务ID",-1)),t("span",null,a(P.value),1)])]),t("article",ps,[s[23]||(s[23]=t("h3",null,"连续性评分",-1)),t("div",gs,a(l((y=b.value.summary)==null?void 0:y.continuity_score,3)),1),t("div",ys,[s[22]||(s[22]=t("span",null,"尖灭比例",-1)),t("span",null,a(l((_=b.value.summary)==null?void 0:_.pinchout_ratio,3)),1)])]),t("article",hs,[s[25]||(s[25]=t("h3",null,"层厚变异系数",-1)),t("div",bs,a(l((v=b.value.summary)==null?void 0:v.layer_cv,3)),1),t("div",fs,[s[24]||(s[24]=t("span",null,"零/负厚比",-1)),t("span",null,a(l((p=b.value.summary)==null?void 0:p.zero_or_negative_ratio,3)),1)])]),t("article",ks,[s[26]||(s[26]=t("h3",null,"质量告警",-1)),t("div",ws,[(o=b.value.warning_flags)!=null&&o.low_continuity?(c(),d("span",Ss,"低连续性")):C("",!0),(g=b.value.warning_flags)!=null&&g.high_pinchout?(c(),d("span",xs,"尖灭比例高")):C("",!0),(f=b.value.warning_flags)!=null&&f.high_variability?(c(),d("span",Is,"层厚变异高")):C("",!0),!b.value.warning_flags||!b.value.warning_flags.low_continuity&&!b.value.warning_flags.high_pinchout&&!b.value.warning_flags.high_variability?(c(),d("span",Ps,"无明显告警")):C("",!0)])])])):(c(),d("div",Ms,"输入 Geomodel 任务ID 后读取质量摘要并纳入报告。"))]),t("section",Rs,[s[29]||(s[29]=t("h2",null,"详细统计表",-1)),k.value.length?(c(),d("div",Ds,[t("table",null,[s[28]||(s[28]=t("thead",null,[t("tr",null,[t("th",null,"指标"),t("th",null,"最小值"),t("th",null,"最大值"),t("th",null,"平均值"),t("th",null,"标准差"),t("th",null,"P10"),t("th",null,"P50"),t("th",null,"P90")])],-1)),t("tbody",null,[(c(!0),d(T,null,L(k.value,n=>(c(),d("tr",{key:`table-${n.name}`},[t("td",null,a(n.name),1),t("td",null,a(l(n.stats.min,3)),1),t("td",null,a(l(n.stats.max,3)),1),t("td",null,a(l(n.stats.mean,3)),1),t("td",null,a(l(n.stats.std,3)),1),t("td",null,a(l(n.stats.p10,3)),1),t("td",null,a(l(n.stats.p50,3)),1),t("td",null,a(l(n.stats.p90,3)),1)]))),128))])])])):(c(),d("div",zs,a(S.value?"正在自动生成明细统计...":"暂无明细统计数据"),1))])])}}},Vs=pt(Cs,[["__scopeId","data-v-33a45bd0"]]);export{Vs as default};
