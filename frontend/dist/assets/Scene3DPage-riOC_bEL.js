var J=(d,Z,a)=>new Promise((A,p)=>{var w=c=>{try{$(a.next(c))}catch(D){p(D)}},g=c=>{try{$(a.throw(c))}catch(D){p(D)}},$=c=>c.done?A(c.value):Promise.resolve(c.value).then(w,g);$((a=a.apply(d,Z)).next())});import{b as r,bf as _e,b4 as we,w as oe,b5 as b,b8 as f,b7 as e,bb as o,bi as L,bc as ie,b9 as be,ba as te,b6 as ke,br as ue,bv as he,bn as ye,c as F,bu as Se,bs as Te,bj as Ne,bE as Fe}from"./vendor-DlrH7ZQK.js";import{u as De}from"./vue-router-u9NpsLKd.js";import{_ as $e,b as Ie}from"./index-DeI7uYOw.js";import{A as Ae}from"./AsyncState-D2kxFDYv.js";import{V as xe,a as Re,Z as Me}from"./api-C8NVcaPd.js";import"./network-T6nY3V_4.js";const Ve={class:"viewer-header"},Pe={class:"header-left"},Be={class:"viewer-title"},Le={key:0,class:"viewer-subtitle"},Ee={class:"header-center"},je={class:"indicator-tabs"},ze=["onClick"],We={class:"header-right"},Oe={class:"view-modes"},Ue={class:"viewer-content"},qe={class:"layer-controls-overlay"},Ge={class:"layer-controls"},He={class:"layer-toggles"},Xe=["checked","onChange"],Ye={class:"layer-name"},Je={class:"scale-overlay"},Ze={class:"value-scale"},Ke={class:"scale-labels"},Qe={key:0,class:"stats-overlay"},et={class:"stats-panel"},tt={class:"stats-list"},st={class:"stat-item"},lt={class:"stat-item"},nt={class:"stat-item"},at={class:"stat-item"},ot={class:"split-view"},it={key:0,class:"inspector-panel"},ut={class:"inspector-header"},rt={class:"inspector-content"},ct={class:"data-row"},dt={class:"data-row"},vt={class:"data-row"},mt={__name:"Scene3DViewer",props:{title:{type:String,default:"3D 可视化"},subtitle:String,fullscreen:{type:Boolean,default:!1},showInspector:{type:Boolean,default:!1},sceneData:{type:Object,default:null},layers:{type:Array,default:()=>[]},indicatorValues:{type:Object,default:null},bounds:{type:Object,default:null},stats:{type:Object,default:null},loading:{type:Boolean,default:!1},loadingText:String,errorText:{type:String,default:""},emptyText:String,emptyAction:Object},emits:["fullscreen-toggle","indicator-change","layer-toggle","point-select","view-change"],setup(d,{emit:Z}){const a=d,A=Z,p=r(null),w=r(null),g=r("scene"),$=r("mpi"),c=r(!0),D=r(a.fullscreen),K=[{id:"mpi",label:"MPI",color:"#0f766e"},{id:"rsi",label:"RSI",color:"#3b82f6"},{id:"bri",label:"BRI",color:"#f59e0b"},{id:"asi",label:"ASI",color:"#10b981"}],R=F(()=>{var l;return!!a.sceneData||(((l=a.layers)==null?void 0:l.length)||0)>0}),I=F(()=>{var O,Q,P,U,q,G,H,ee;const l=a.stats&&typeof a.stats=="object"?a.stats:{},s=Number((Q=(O=l[`${$.value}_min`])!=null?O:l.min)!=null?Q:0),v=Number((U=(P=l[`${$.value}_max`])!=null?P:l.max)!=null?U:1),i=Number((G=(q=l[`${$.value}_mean`])!=null?q:l.mean)!=null?G:0),x=Number((ee=(H=l[`${$.value}_std`])!=null?H:l.std)!=null?ee:0);return{min:Number.isFinite(s)?s:0,max:Number.isFinite(v)?v:1,mean:Number.isFinite(i)?i:0,std:Number.isFinite(x)?x:0}}),se=F(()=>{var s,v,i,x;if(!a.bounds)return"-";const l=a.bounds;return`X:${Number((s=l.min_x)!=null?s:0).toFixed(0)}~${Number((v=l.max_x)!=null?v:0).toFixed(0)} / Y:${Number((i=l.min_y)!=null?i:0).toFixed(0)}~${Number((x=l.max_y)!=null?x:0).toFixed(0)}`}),T=r((a.layers||[]).map(l=>({id:l.id||l.name,name:l.displayName||l.name,color:l.color||N(l.name||"layer"),visible:!0}))),C=l=>{const s=parseFloat(l);return Number.isFinite(s)?s.toFixed(2):"-"},re=l=>{$.value=l,A("indicator-change",l)},fe=l=>{const s=T.value.find(v=>v.id===l);s&&(s.visible=!s.visible,A("layer-toggle",{id:l,visible:s.visible}))},ce=()=>{A("view-change","reset")},E=()=>{D.value=!D.value,A("fullscreen-toggle",D.value)},N=l=>{const s=["#8B5CF6","#EC4899","#F59E0B","#10B981","#3B82F6","#6366F1","#14B8A6","#F97316"];let v=0;for(let i=0;i<l.length;i+=1)v=l.charCodeAt(i)+((v<<5)-v);return s[Math.abs(v)%s.length]};let M=null,k=null,y=null,le=null;const de=()=>J(this,null,function*(){if(!w.value||!p.value||!R.value)return;const{Scene:l,PerspectiveCamera:s,WebGLRenderer:v,Color:i,Mesh:x,PlaneGeometry:O,MeshBasicMaterial:Q,DoubleSide:P}=yield Ie(()=>J(this,null,function*(){const{Scene:ee,PerspectiveCamera:pe,WebGLRenderer:ge,Color:me,Mesh:n,PlaneGeometry:t,MeshBasicMaterial:u,DoubleSide:h}=yield import("./vendor-DlrH7ZQK.js").then(m=>m.bF);return{Scene:ee,PerspectiveCamera:pe,WebGLRenderer:ge,Color:me,Mesh:n,PlaneGeometry:t,MeshBasicMaterial:u,DoubleSide:h}}),[]),U=p.value.clientWidth||800,q=p.value.clientHeight||500;M=new l,M.background=new i(16317180),k=new s(60,U/q,.1,1e3),k.position.set(50,60,100),k.lookAt(0,0,0),y=new v({canvas:w.value,antialias:!0,alpha:!0}),y.setSize(U,q),y.setPixelRatio(window.devicePixelRatio||1);const G=new x(new O(220,220,20,20),new Q({color:14870768,side:P}));G.rotation.x=-Math.PI/2,M.add(G);const H=()=>{!y||!M||!k||(le=requestAnimationFrame(H),y.render(M,k))};H()}),ve=()=>{if(!k||!y||!p.value)return;const l=p.value.clientWidth,s=p.value.clientHeight;k.aspect=l/s,k.updateProjectionMatrix(),y.setSize(l,s)};return _e(()=>{window.addEventListener("resize",ve),R.value&&!a.loading&&!a.errorText&&de()}),we(()=>{window.removeEventListener("resize",ve),le&&cancelAnimationFrame(le),y&&y.dispose()}),oe(()=>a.layers,()=>{T.value=(a.layers||[]).map(l=>({id:l.id||l.name,name:l.displayName||l.name,color:l.color||N(l.name||"layer"),visible:!0}))},{deep:!0}),oe(()=>[a.sceneData,a.loading,a.errorText],()=>J(this,null,function*(){a.loading||a.errorText||!R.value||(yield de())}),{deep:!0}),oe(g,l=>A("view-change",l)),(l,s)=>{var v;return b(),f("div",{class:te(["scene-3d-viewer",{fullscreen:d.fullscreen,"show-inspector":d.showInspector}])},[e("header",Ve,[e("div",Pe,[e("h2",Be,o(d.title),1),d.subtitle?(b(),f("span",Le,o(d.subtitle),1)):L("",!0)]),e("div",Ee,[e("div",je,[(b(),f(ie,null,be(K,i=>e("button",{key:i.id,class:te(["tab-btn",{active:$.value===i.id}]),onClick:x=>re(i.id)},o(i.label),11,ze)),64))])]),e("div",We,[e("div",Oe,[e("button",{class:te(["mode-btn",{active:g.value==="scene"}]),onClick:s[0]||(s[0]=i=>g.value="scene"),title:"3D 场景"}," 3D ",2),e("button",{class:te(["mode-btn",{active:g.value==="split"}]),onClick:s[1]||(s[1]=i=>g.value="split"),title:"分屏对比"}," 分屏 ",2)]),e("div",{class:"header-actions"},[e("button",{class:"icon-btn",onClick:ce,title:"重置视角"},"⟲"),e("button",{class:"icon-btn",onClick:E,title:"全屏"},"⛶")])])]),e("div",Ue,[d.loading||!R.value||d.errorText?(b(),ke(Ae,{key:0,loading:d.loading,hasData:R.value,errorText:d.errorText,loadingText:d.loadingText||"加载 3D 场景...",emptyText:d.emptyText||"暂无可视化数据",action:d.emptyAction},null,8,["loading","hasData","errorText","loadingText","emptyText","action"])):(b(),f(ie,{key:1},[ue(e("div",{class:"scene-container",ref_key:"sceneContainer",ref:p},[e("canvas",{ref_key:"canvasRef",ref:w,class:"three-canvas"},null,512),e("div",qe,[e("div",Ge,[s[3]||(s[3]=e("h4",{class:"controls-title"},"图层",-1)),e("div",He,[(b(!0),f(ie,null,be(T.value,i=>(b(),f("label",{key:i.id,class:"layer-toggle"},[e("input",{type:"checkbox",checked:i.visible,onChange:x=>fe(i.id)},null,40,Xe),e("span",{class:"layer-color",style:ye({background:i.color})},null,4),e("span",Ye,o(i.name),1)]))),128))])])]),e("div",Je,[e("div",Ze,[e("div",Ke,[e("span",null,o(C(I.value.min)),1),e("span",null,o(C(I.value.max)),1)]),s[4]||(s[4]=e("div",{class:"scale-bar"},null,-1))])]),c.value?(b(),f("div",Qe,[e("div",et,[s[9]||(s[9]=e("h4",{class:"stats-title"},"统计",-1)),e("div",tt,[e("div",st,[s[5]||(s[5]=e("span",null,"最小",-1)),e("strong",null,o(C(I.value.min)),1)]),e("div",lt,[s[6]||(s[6]=e("span",null,"最大",-1)),e("strong",null,o(C(I.value.max)),1)]),e("div",nt,[s[7]||(s[7]=e("span",null,"平均",-1)),e("strong",null,o(C(I.value.mean)),1)]),e("div",at,[s[8]||(s[8]=e("span",null,"标准差",-1)),e("strong",null,o(C(I.value.std)),1)])])])])):L("",!0)],512),[[he,g.value==="scene"]]),ue(e("div",ot,[...s[10]||(s[10]=[e("div",{class:"split-panel"},"3D 场景",-1),e("div",{class:"split-panel"},"二维热力图",-1)])],512),[[he,g.value==="split"]]),d.showInspector?(b(),f("div",it,[e("div",ut,[s[11]||(s[11]=e("h3",null,"详细信息",-1)),e("button",{class:"close-btn",onClick:s[2]||(s[2]=i=>l.$emit("view-change","close-inspector"))},"×")]),e("div",rt,[e("div",ct,[s[12]||(s[12]=e("span",null,"当前指标",-1)),e("strong",null,o($.value.toUpperCase()),1)]),e("div",dt,[s[13]||(s[13]=e("span",null,"图层数量",-1)),e("strong",null,o(((v=d.layers)==null?void 0:v.length)||0),1)]),e("div",vt,[s[14]||(s[14]=e("span",null,"坐标范围",-1)),e("strong",null,o(se.value),1)])])])):L("",!0)],64))]),d.fullscreen?(b(),f("button",{key:0,class:"fullscreen-close",onClick:E},"×")):L("",!0)],2)}}},bt=$e(mt,[["__scopeId","data-v-718fa3ef"]]),ft={class:"scene3d-page"},pt={class:"page-header"},gt={class:"header-actions"},yt=["disabled"],ht={class:"summary-strip"},xt={class:"chip"},_t={class:"chip"},wt={key:0,class:"chip"},$t={class:"main-layout"},Ct={class:"side-panel"},kt={class:"card"},St={class:"field"},Tt=["disabled"],Nt=["value"],Ft={class:"field"},Dt={key:0,class:"error-tip"},It={key:0,class:"card"},At={class:"indicator-list"},Rt=["value"],Mt={class:"name"},Vt={class:"desc"},Pt={key:1,class:"card"},Bt={class:"kv"},Lt={class:"kv"},Et={class:"kv stack"},jt={class:"viewer-panel"},zt={key:0,class:"stats-panel"},Wt={class:"card"},Ot={class:"metric-row"},Ut={class:"hist"},qt={__name:"Scene3DPage",setup(d){const Z=De(),a=r(""),A=r([]),p=r(50),w=r(!1),g=r(!1),$=r(!1),c=r(""),D=r(""),K=r(null),R=r([]),I=r(null),se=r(null),T=r(null),C=r("mpi"),re=[{id:"mpi",name:"MPI",fullName:"矿压影响指标",description:"综合压力评估",color:"#0f766e"},{id:"rsi",name:"RSI",fullName:"顶板稳定指数",description:"稳定状态评估",color:"#3b82f6"},{id:"bri",name:"BRI",fullName:"冲击风险指数",description:"危险程度评估",color:"#f59e0b"},{id:"asi",name:"ASI",fullName:"支承应力指数",description:"应力分布评估",color:"#10b981"}],fe=r(null),ce=r(null);let E=null,N=null;const M=F(()=>(A.value||[]).map(n=>typeof n=="string"?n:n==null?void 0:n.name).filter(n=>typeof n=="string"&&n.length>0)),k=F(()=>re.find(n=>n.id===C.value)),y=F(()=>{var B,j,V,z,W,Y,ne,ae;const n=I.value;if(!n||typeof n!="object")return{min:0,max:1,mean:.5,std:0};const t=C.value,u=n[t]||n[String(t).toUpperCase()]||n;if(!u||typeof u!="object")return{min:0,max:1,mean:.5,std:0};const h=Number((j=(B=u.min)!=null?B:u.minimum)!=null?j:0),m=Number((z=(V=u.max)!=null?V:u.maximum)!=null?z:1),_=Number((Y=(W=u.mean)!=null?W:u.avg)!=null?Y:.5),X=Number((ae=(ne=u.std)!=null?ne:u.stdev)!=null?ae:0);return{min:Number.isFinite(h)?h:0,max:Number.isFinite(m)?m:1,mean:Number.isFinite(_)?_:.5,std:Number.isFinite(X)?X:0}}),le=F(()=>{var n;return`${((n=k.value)==null?void 0:n.name)||"MPI"} 三维可视化`}),de=F(()=>a.value?`煤层: ${a.value}`:"三维指标可视化系统"),ve=F(()=>!!a.value&&!w.value),l=F(()=>w.value?a.value?`正在自动加载煤层 ${a.value} 的场景...`:"正在自动加载场景...":""),s=F(()=>a.value?"未获取到场景数据，请检查后端接口返回。":"请先选择煤层"),v=F(()=>c.value?{label:"重试加载",onClick:()=>P()}:null),i=F(()=>w.value?"自动加载中":c.value?"加载失败":g.value?"已自动加载":"等待数据"),x=n=>{const t=Number(n);return Number.isFinite(t)?t.toFixed(3):"-"},O=(n=260)=>{a.value&&(E&&clearTimeout(E),E=setTimeout(()=>{P()},n))},Q=()=>J(this,null,function*(){var t;const n=yield Re();A.value=((t=n.data)==null?void 0:t.seams)||[]}),P=()=>J(this,null,function*(){var t,u,h;if(!a.value)return;N&&N.abort(),N=new AbortController;const{signal:n}=N;w.value=!0,c.value="";try{const _=(yield Me(a.value,p.value,{signal:n})).data||{};K.value=(t=_.scene)!=null?t:{seam:a.value,resolution:p.value},R.value=Array.isArray(_.layers)?_.layers:[],I.value=_.indicators||_.indicatorValues||{},se.value=(u=_.bounds)!=null?u:null,T.value=(h=_.stats)!=null?h:null,g.value=!!K.value||R.value.length>0,D.value=new Date().toLocaleTimeString("zh-CN",{hour12:!1}),setTimeout(me,60)}catch(m){if((m==null?void 0:m.name)==="AbortError"||(m==null?void 0:m.code)==="ERR_CANCELED")return;g.value=!1,c.value=xe(m,"场景加载失败"),console.error("Failed to load scene data:",m)}finally{(N==null?void 0:N.signal)===n&&(N=null),w.value=!1}}),U=()=>{g.value=!1,K.value=null,R.value=[],I.value=null,se.value=null,T.value=null,c.value="",D.value=""},q=()=>{U(),O(120)},G=n=>{$.value=n},H=n=>{C.value=n},ee=()=>{},pe=()=>{},ge=()=>{},me=()=>{const n=ce.value;if(!n)return;const t=n.getContext("2d");if(!t)return;const u=n.width=n.offsetWidth||280,h=n.height=150,m=y.value.min,_=y.value.max,X=y.value.mean;t.clearRect(0,0,u,h),t.fillStyle="#f1f5f9",t.fillRect(0,0,u,h);const B=18,j=u/B;for(let V=0;V<B;V+=1){const z=V/(B-1),W=20+Math.sin(z*Math.PI)*70,Y=h-W-20;t.fillStyle=`rgba(15,118,110,${.25+z*.55})`,t.fillRect(V*j+2,Y,j-4,W)}t.fillStyle="#334155",t.font="12px sans-serif",t.fillText(`min ${x(m)}`,8,h-4),t.fillText(`mean ${x(X)}`,u/2-30,h-4),t.fillText(`max ${x(_)}`,u-88,h-4)};return _e(()=>J(this,null,function*(){try{yield Q()}catch(t){c.value=xe(t,"煤层列表加载失败");return}const n=typeof Z.query.seam=="string"?Z.query.seam:"";n&&M.value.includes(n)?a.value=n:M.value.length>0&&(a.value=M.value[0]),a.value&&(yield P())})),oe(()=>p.value,()=>{a.value&&O()}),oe(C,()=>{g.value&&me()}),we(()=>{E&&clearTimeout(E),N&&N.abort()}),(n,t)=>{var u,h,m,_,X,B,j,V,z,W,Y,ne,ae;return b(),f("div",ft,[e("header",pt,[t[3]||(t[3]=e("div",null,[e("p",{class:"eyebrow"},"3D Workspace"),e("h1",null,"三维指标可视化"),e("p",{class:"subtitle"},"页面打开后自动加载默认煤层数据，无需手动点击开始。")],-1)),e("div",gt,[e("button",{class:"btn secondary",disabled:!ve.value,onClick:P},"刷新",8,yt)])]),e("div",ht,[e("span",xt,"当前煤层："+o(a.value||"未选择"),1),e("span",_t,"分辨率："+o(p.value),1),e("span",{class:te(["chip",{loading:w.value,error:!!c.value}])},o(i.value),3),D.value?(b(),f("span",wt,"更新于："+o(D.value),1)):L("",!0)]),e("div",$t,[e("aside",Ct,[e("section",kt,[t[7]||(t[7]=e("h3",null,"数据源",-1)),e("label",St,[t[5]||(t[5]=e("span",null,"煤层",-1)),ue(e("select",{"onUpdate:modelValue":t[0]||(t[0]=S=>a.value=S),disabled:w.value,onChange:q},[t[4]||(t[4]=e("option",{value:""},"-- 请选择 --",-1)),(b(!0),f(ie,null,be(M.value,S=>(b(),f("option",{key:S,value:S},o(S),9,Nt))),128))],40,Tt),[[Se,a.value]])]),e("label",Ft,[t[6]||(t[6]=e("span",null,"分辨率",-1)),ue(e("input",{"onUpdate:modelValue":t[1]||(t[1]=S=>p.value=S),type:"number",min:"20",max:"150",step:"10"},null,512),[[Te,p.value,void 0,{number:!0}]])]),c.value?(b(),f("p",Dt,o(c.value),1)):L("",!0)]),g.value?(b(),f("section",It,[t[8]||(t[8]=e("h3",null,"显示指标",-1)),e("div",At,[(b(),f(ie,null,be(re,S=>e("label",{key:S.id,class:te(["indicator-item",{active:C.value===S.id}])},[ue(e("input",{"onUpdate:modelValue":t[2]||(t[2]=Ce=>C.value=Ce),type:"radio",value:S.id},null,8,Rt),[[Fe,C.value]]),e("span",{class:"dot",style:ye({background:S.color})},null,4),e("span",Mt,o(S.name),1),e("span",Vt,o(S.description),1)],2)),64))])])):L("",!0),T.value?(b(),f("section",Pt,[t[12]||(t[12]=e("h3",null,"场景信息",-1)),e("div",Bt,[t[9]||(t[9]=e("span",null,"图层",-1)),e("strong",null,o((u=T.value.layerCount)!=null?u:0),1)]),e("div",Lt,[t[10]||(t[10]=e("span",null,"钻孔",-1)),e("strong",null,o((h=T.value.boreholeCount)!=null?h:0),1)]),e("div",Et,[t[11]||(t[11]=e("span",null,"范围",-1)),e("small",null," X: "+o((_=(m=T.value.bounds)==null?void 0:m.min_x)!=null?_:"-")+" - "+o((B=(X=T.value.bounds)==null?void 0:X.max_x)!=null?B:"-"),1),e("small",null," Y: "+o((V=(j=T.value.bounds)==null?void 0:j.min_y)!=null?V:"-")+" - "+o((W=(z=T.value.bounds)==null?void 0:z.max_y)!=null?W:"-"),1)])])):L("",!0)]),e("main",jt,[Ne(bt,{ref_key:"viewerRef",ref:fe,title:le.value,subtitle:de.value,fullscreen:$.value,showInspector:!0,sceneData:K.value,layers:R.value,indicatorValues:I.value,indicatorConfig:k.value,stats:y.value,bounds:se.value,loading:w.value,loadingText:l.value,errorText:c.value,emptyText:s.value,emptyAction:v.value,onFullscreenToggle:G,onIndicatorChange:H,onLayerToggle:ee,onPointSelect:pe,onViewChange:ge},null,8,["title","subtitle","fullscreen","sceneData","layers","indicatorValues","indicatorConfig","stats","bounds","loading","loadingText","errorText","emptyText","emptyAction"])]),g.value?(b(),f("aside",zt,[e("section",Wt,[t[16]||(t[16]=e("h3",null,"当前指标",-1)),e("div",{class:"indicator-head",style:ye({borderLeftColor:(Y=k.value)==null?void 0:Y.color})},[e("strong",null,o((ne=k.value)==null?void 0:ne.name),1),e("small",null,o((ae=k.value)==null?void 0:ae.fullName),1)],4),e("div",Ot,[e("div",null,[t[13]||(t[13]=e("small",null,"最小",-1)),e("strong",null,o(x(y.value.min)),1)]),e("div",null,[t[14]||(t[14]=e("small",null,"最大",-1)),e("strong",null,o(x(y.value.max)),1)]),e("div",null,[t[15]||(t[15]=e("small",null,"平均",-1)),e("strong",null,o(x(y.value.mean)),1)])]),e("div",Ut,[e("canvas",{ref_key:"histogramCanvas",ref:ce},null,512)])])])):L("",!0)])])}}},Qt=$e(qt,[["__scopeId","data-v-07119992"]]);export{Qt as default};
